<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë©”ì´ë“œ ì¹´í˜ - ì£¼ì¸ë‹˜ì˜ ê³µê°„</title>
    <style>
        /* ê¸°ë³¸ ìŠ¤íƒ€ì¼ */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f4f4f4;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 10px; /* ì „ì²´ íŒ¨ë”© ì¤„ì„ */
            box-sizing: border-box;
            color: #333;
        }

        .container {
            display: flex;
            width: 98%; /* ë„ˆë¹„ ì¡°ì • */
            max-width: 1200px;
            height: 95vh; /* ë†’ì´ ì¡°ì • */
            background-color: #fff;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            transition: all 0.3s ease-in-out;
        }

        /* ìƒíƒœ íŒ¨ë„ */
        .status-panel {
            width: 300px; /* ë„ˆë¹„ ì¡°ê¸ˆ ëŠ˜ë¦¼ */
            background-color: #ffe0f2; /* ë°ì€ í•‘í¬ */
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            border-right: 1px solid #f8bbd0;
            box-sizing: border-box;
            flex-shrink: 0;
            overflow-y: auto; /* ë‚´ìš© ë§ì•„ì§€ë©´ ìŠ¤í¬ë¡¤ */
        }
        .status-panel h3 {
            color: #e91e63;
            margin-top: 0;
            margin-bottom: 10px;
            border-bottom: 2px solid #f8bbd0;
            padding-bottom: 5px;
            font-size: 1.3em;
        }
        .status-item {
            display: flex;
            flex-direction: column;
            margin-bottom: 5px;
        }
        .status-item strong {
            color: #c2185b;
            font-size: 0.95em;
            margin-bottom: 3px;
        }
        .status-item span {
            font-size: 1.05em;
            color: #333;
            word-break: break-all;
        }
        .status-item.current-time {
            font-size: 1.15em;
            font-weight: bold;
            color: #2196f3;
        }
        .game-time-control {
            background-color: #e0f2f7;
            padding: 10px;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            align-items: flex-start;
        }
        .game-time-control strong {
            color: #0d47a1;
            font-size: 1em;
        }
        .game-time-control button {
            background-color: #2196f3;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background-color 0.2s;
            width: 100%; /* ë²„íŠ¼ ë„ˆë¹„ í™•ì¥ */
        }
        .game-time-control button:hover {
            background-color: #1976d2;
        }

        /* ì±„íŒ… ì˜ì—­ */
        .chat-area {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }
        .chat-header {
            background-color: #e91e63;
            color: white;
            padding: 15px;
            text-align: center;
            font-size: 1.3em;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            position: relative;
        }
        .hamburger-menu {
            display: none; /* ê¸°ë³¸ì ìœ¼ë¡œ ìˆ¨ê¹€ */
            font-size: 1.8em;
            cursor: pointer;
            color: white;
            position: absolute;
            left: 15px;
        }
        .current-character-display {
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 8px;
            flex-grow: 1;
            justify-content: center;
        }
        .current-character-display .icon {
            font-size: 1.6em;
        }

        /* ìºë¦­í„°/ë£¸ ì„ íƒ, ì˜ˆì•½, ì´ˆê¸°í™” íŒ¨ë„ */
        .control-panel {
            background-color: #fce4ec;
            padding: 15px;
            border-bottom: 1px solid #f8bbd0;
            display: flex;
            flex-direction: column;
            gap: 12px;
            overflow-y: auto; /* ì‘ì€ í™”ë©´ì—ì„œ ìŠ¤í¬ë¡¤ ê°€ëŠ¥í•˜ê²Œ */
            flex-shrink: 0;
        }
        .control-panel label {
            font-weight: bold;
            color: #c2185b;
            font-size: 1em;
        }
        .button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        .button-group button {
            background-color: #ff80ab;
            color: white;
            border: none;
            padding: 9px 18px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 0.95em;
            transition: background-color 0.2s, transform 0.1s;
        }
        .button-group button:hover:not(.active) {
            background-color: #e91e63;
            transform: translateY(-1px);
        }
        .button-group button.active {
            background-color: #c2185b;
            border: 2px solid #880e4f;
            font-weight: bold;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }
        #master-tempus-btn {
            background-color: #607d8b;
        }
        #master-tempus-btn:hover:not(.active) {
            background-color: #455a64;
        }
        #master-tempus-btn.active {
            background-color: #37474f;
            border: 2px solid #1a237e;
        }
        #clear-btn {
            background-color: #f44336;
            width: fit-content;
            align-self: flex-end;
            margin-top: 10px;
        }
        #clear-btn:hover {
            background-color: #d32f2f;
        }

        /* ì˜ˆì•½ ì˜ì—­ */
        .reservation-area {
            background-color: #fce4ec;
            padding: 15px;
            border-top: 1px solid #f8bbd0;
            display: flex;
            flex-direction: column;
            gap: 10px;
            align-items: flex-start;
            display: none; /* ê¸°ë³¸ì ìœ¼ë¡œ ìˆ¨ê¹€ */
        }
        .reservation-area.active {
            display: flex;
        }
        .reservation-area input[type="number"],
        .reservation-area select {
            padding: 8px;
            border-radius: 5px;
            border: 1px solid #ccc;
            font-size: 1em;
            width: 100%; /* ë„ˆë¹„ ì¡°ì • */
            max-width: 200px;
            box-sizing: border-box;
        }
        .reservation-area button {
            background-color: #e91e63;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            width: fit-content;
        }
        .reservation-area button:hover {
            background-color: #c2185b;
        }
        .reservation-status {
            font-weight: bold;
            color: #e91e63;
            font-size: 1.05em;
        }
        .reservation-status.active-chat {
            color: #4caf50;
        }
        .reservation-status.expired-chat {
            color: #f44336;
        }

        /* ì±„íŒ… ë©”ì‹œì§€ ì˜ì—­ */
        .chat-messages {
            flex-grow: 1;
            padding: 20px;
            overflow-y: auto;
            border-bottom: 1px solid #eee;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .message {
            padding: 10px 15px;
            border-radius: 18px;
            max-width: 85%; /* ìµœëŒ€ ë„ˆë¹„ ì¡°ì • */
            display: flex;
            align-items: flex-start;
            gap: 8px;
            font-size: 1.05em;
            line-height: 1.5;
            word-wrap: break-word; /* ê¸´ ë‹¨ì–´ ì¤„ë°”ê¿ˆ */
        }
        .user {
            background-color: #dcf8c2;
            align-self: flex-end;
            margin-left: auto;
            border-bottom-right-radius: 5px; /* ë§í’ì„  ê¼¬ë¦¬ íš¨ê³¼ */
        }
        .bot {
            background-color: #ffe0f2;
            align-self: flex-start;
            margin-right: auto;
            border-bottom-left-radius: 5px; /* ë§í’ì„  ê¼¬ë¦¬ íš¨ê³¼ */
        }
        .message .icon {
            font-size: 1.2em;
            flex-shrink: 0;
            line-height: 1;
        }
        .message .user-label {
            font-weight: bold;
            flex-shrink: 0;
            color: #555;
        }

        /* ì…ë ¥ ì˜ì—­ */
        .input-area {
            display: flex;
            padding: 15px;
            border-top: 1px solid #eee;
            background-color: #fff;
            gap: 10px;
        }
        .input-area input {
            flex-grow: 1;
            padding: 12px 18px;
            border: 1px solid #ccc;
            border-radius: 25px;
            font-size: 1em;
            transition: border-color 0.2s;
        }
        .input-area input:focus {
            border-color: #e91e63;
            outline: none;
        }
        .input-area button {
            background-color: #e91e63;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1em;
            white-space: nowrap;
            transition: background-color 0.2s;
        }
        .input-area button:disabled {
            background-color: #ffcdd2;
            cursor: not-allowed;
        }

        /* ëª¨ë°”ì¼ ë°˜ì‘í˜• */
        @media (max-width: 768px) {
            body {
                padding: 5px;
            }
            .container {
                flex-direction: column;
                height: 98vh; /* ëª¨ë°”ì¼ì—ì„œ ì „ì²´ ë†’ì´ ì‚¬ìš© */
                border-radius: 0; /* ëª¨ë°”ì¼ì—ì„œ í…Œë‘ë¦¬ ì œê±° */
                box-shadow: none;
            }
            .status-panel {
                width: 100%;
                height: auto;
                max-height: 50%; /* ìˆ¨ê²¨ì§ˆ ë•Œë¥¼ ëŒ€ë¹„í•œ ìµœëŒ€ ë†’ì´ */
                position: fixed; /* ëª¨ë°”ì¼ì—ì„œ ê³ ì • */
                top: 0;
                left: 0;
                transform: translateX(-100%); /* ê¸°ë³¸ì ìœ¼ë¡œ ìˆ¨ê¹€ */
                z-index: 100;
                transition: transform 0.3s ease-in-out;
                border-bottom: 1px solid #f8bbd0;
                border-right: none;
                padding-bottom: 60px; /* í–„ë²„ê±° ë©”ë‰´ ë‹«ê¸° ë²„íŠ¼ ê³µê°„ í™•ë³´ */
            }
            .status-panel.active {
                transform: translateX(0); /* í™œì„±í™” ì‹œ ë³´ì„ */
            }
            .hamburger-menu {
                display: block; /* ëª¨ë°”ì¼ì—ì„œ ë³´ì„ */
            }
            .chat-header {
                justify-content: flex-end; /* í–„ë²„ë²„ ë©”ë‰´ ê³µê°„ í™•ë³´ */
            }
            .current-character-display {
                margin-left: 50px; /* í–„ë²„ê±° ë©”ë‰´ ì•„ì´ì½˜ ê³µê°„ */
            }
            .control-panel {
                padding: 10px;
                gap: 10px;
            }
            .control-panel label {
                font-size: 0.95em;
            }
            .button-group button {
                padding: 7px 12px;
                font-size: 0.85em;
            }
            #clear-btn {
                width: 100%;
                text-align: center;
            }
            .chat-messages {
                padding: 15px;
                gap: 10px;
            }
            .message {
                max-width: 90%;
                font-size: 0.95em;
                padding: 8px 12px;
            }
            .input-area {
                padding: 10px;
                gap: 8px;
            }
            .input-area input {
                padding: 10px 15px;
                font-size: 0.95em;
            }
            .input-area button {
                padding: 10px 15px;
                font-size: 0.95em;
            }
            .reservation-area input[type="number"],
            .reservation-area select {
                max-width: 100%;
            }
            .reservation-area button {
                width: 100%;
                text-align: center;
            }
            .close-status-panel-btn {
                display: block; /* ëª¨ë°”ì¼ì—ì„œ ë³´ì„ */
                position: absolute;
                bottom: 10px;
                left: 50%;
                transform: translateX(-50%);
                background-color: #c2185b;
                color: white;
                border: none;
                padding: 8px 15px;
                border-radius: 5px;
                cursor: pointer;
                font-size: 0.9em;
                width: 80%;
            }
        </style>
</head>
<body>
    <div class="container">
        <div class="status-panel" id="status-panel">
            <h3>ğŸ“– ì£¼ì¸ë‹˜ ìƒíƒœì°½</h3>
            <div class="status-item current-time">
                <strong>ê²Œì„ ë‚´ ì‹œê°„:</strong>
                <span id="game-current-time-status"></span>
            </div>
            <div class="status-item">
                <strong>í˜„ì¬ ìœ„ì¹˜:</strong>
                <span id="current-room-status">í”„ë¡ íŠ¸</span>
            </div>
            <div class="status-item">
                <strong>ì„ íƒëœ ë©”ì´ë“œ:</strong>
                <span id="current-maid-status">ì—†ìŒ</span>
            </div>
            <div class="status-item reservation-info">
                <strong>ì˜ˆì•½ í˜„í™©:</strong>
                <span id="reservation-brief-status">ì˜ˆì•½ ì—†ìŒ</span>
            </div>
            <div class="status-item">
                <strong>ë‚¨ì€ ëŒ€í™” íšŸìˆ˜:</strong>
                <span id="turns-left-brief-status">0</span>
            </div>
            <hr style="border-top: 1px dashed #f8bbd0; width: 100%;">
            <div class="game-time-control">
                <strong>ì‹œê°„ ì „ì§„:</strong>
                <button id="forward-1hour">1ì‹œê°„ ì „ì§„</button>
                <button id="forward-1day">1ì¼ ì „ì§„ (ì¶œê·¼ë¶€ ê°±ì‹ )</button>
            </div>
            <button class="close-status-panel-btn" id="close-status-panel-btn">ë‹«ê¸°</button>
        </div>

        <div class="chat-area">
            <div class="chat-header">
                <div class="hamburger-menu" id="hamburger-menu">â˜°</div>
                <div class="current-character-display">
                    <span id="character-icon"></span>
                    <span id="character-name-display"></span>
                </div>
            </div>
            
            <div class="control-panel">
                <label>ì˜¤ëŠ˜ì˜ ì¶œê·¼ ë©”ì´ë“œ:</label>
                <div id="maid-list-container" class="button-group">
                    </div>
                <button id="master-tempus-btn" class="button-group">ë§ˆìŠ¤í„° í…œí‘¸ìŠ¤ (ì˜ˆì•½ ê´€ë¦¬)</button>
                <hr style="border-top: 1px dashed #f8bbd0; width: 100%;">
                <label>ì´ë™í•  ê³µê°„:</label>
                <div id="room-list-container" class="button-group">
                    <button data-room-key="front">í”„ë¡ íŠ¸</button>
                    <button data-room-key="room1">1ë²ˆ ë°©</button>
                    <button data-room-key="room2">2ë²ˆ ë°©</button>
                    <button data-room-key="room_special">íŠ¹ë³„ì‹¤</button>
                </div>
                <button id="clear-btn">ì „ì²´ ì´ˆê¸°í™” (ê²Œì„ ì¬ì‹œì‘)</button>
            </div>

            <div class="reservation-area" id="reservation-area">
                <h3>ğŸ•°ï¸ ì˜ˆì•½í•˜ê¸°</h3>
                <label for="reserve-maid-select">ëŒ€í™”í•  ë©”ì´ë“œ:</label>
                <select id="reserve-maid-select"></select>

                <label for="reserve-date-select">ì˜ˆì•½ ë‚ ì§œ:</label>
                <select id="reserve-date-select"></select>

                <label for="reserve-time-select">ì˜ˆì•½ ì‹œê°„:</label>
                <select id="reserve-time-select"></select>
                
                <button id="reserve-btn">ì˜ˆì•½ í™•ì •</button>
                <div class="reservation-status" id="reservation-status"></div>
                <div class="remaining-turns" id="remaining-turns"></div>
            </div>

            <div class="chat-messages" id="chat">
                </div>
            <div class="input-area">
                <input type="text" id="user-input" placeholder="ì£¼ì¸ë‹˜, ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”?">
                <button id="send-btn">ì „ì†¡</button>
            </div>
        </div>
    </div>

    <script>
        // --- ğŸš¨ ì¤‘ìš”: ì—¬ê¸°ì— ì‹¤ì œ Gemini API í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”! ğŸš¨ ---
        const API_KEY = 'AIzaSyCfYa0mjnn6EP7AhvAOXK3A0XFoszR8aVQ'; // ì—¬ê¸°ì— ì‹¤ì œ API í‚¤ë¥¼ ë„£ìœ¼ì„¸ìš”!
        // --- AI ëª¨ë¸ ì´ë¦„ ë³€ê²½ ---
        const modelName = "gemini-2.5-flash-preview-05-20";

        // --- ëŒ€í™” ê¸°ë¡ ë° ìš”ì•½ ê´€ë ¨ ìƒìˆ˜ ---
        const MAX_HISTORY_MESSAGES = 10; // ì‹¤ì œ ëŒ€í™” ê¸°ë¡(user/model ìŒ)ì˜ ìµœëŒ€ ê¸¸ì´
        const SUMMARY_MESSAGES_TO_REMOVE = 4; // ìš”ì•½ í›„ ì œê±°í•  ì´ì „ ëŒ€í™” ë©”ì‹œì§€ ìˆ˜ (user/model ê° 2ê°œì”©)
        const CONVERSATION_MAX_TURNS_PER_MAID = 10; // ë©”ì´ë“œë³„ ê¸°ë³¸ ëŒ€í™” íšŸìˆ˜

        // --- âœ¨ ì „ì²´ ë°°ê²½ ì •ë³´ ì •ì˜ âœ¨ ---
        const globalGameSetting = `
            ë‹¹ì‹ ì€ 'ë©”ì´ë“œ ì¹´í˜ - ì£¼ì¸ë‹˜ì˜ ê³µê°„'ì´ë¼ëŠ” ê°€ìƒ ì„¸ê³„ì— ìˆëŠ” ë©”ì´ë“œ ë˜ëŠ” ì¹´í˜ ê´€ë¦¬ì(ë§ˆìŠ¤í„° í…œí‘¸ìŠ¤)ì…ë‹ˆë‹¤.
            ì´ ì¹´í˜ëŠ” 2025ë…„ í˜„ëŒ€ í•œêµ­ í‰íƒì‹œì— ìœ„ì¹˜í•œ íŠ¹ë³„í•œ ë©”ì´ë“œ ì¹´í˜ì…ë‹ˆë‹¤.
            ì£¼ì¸ë‹˜ì€ ì´ ì¹´í˜ì˜ ì†Œì¤‘í•œ ì†ë‹˜ì´ë©°, ë‹¹ì‹ ì€ í•­ìƒ ì£¼ì¸ë‹˜ì„ ìµœìš°ì„ ìœ¼ë¡œ ìƒê°í•˜ê³  ì‘ëŒ€í•´ì•¼ í•©ë‹ˆë‹¤.
            ì¹´í˜ ë‚´ë¶€ì˜ ì‹œê°„ì€ ì‹¤ì œ ì‹œê°„ê³¼ ë‹¤ë¥´ê²Œ í˜ëŸ¬ê°€ë©°, ì˜ˆì•½ ì‹œìŠ¤í…œìœ¼ë¡œ ìš´ì˜ë©ë‹ˆë‹¤.
            ë§ˆìŠ¤í„° í…œí‘¸ìŠ¤ê°€ ì˜ˆì•½ê³¼ ì¹´í˜ ê´€ë¦¬ë¥¼ ì´ê´„í•©ë‹ˆë‹¤.
            ë©”ì´ë“œë“¤ì€ ê°ìì˜ ê°œì„±ê³¼ ë§íˆ¬ë¥¼ ê°€ì§€ê³  ìˆìŠµë‹ˆë‹¤.
            ì‚¬ìš©ìëŠ” ì˜¤ì§ ì˜ˆì•½ëœ ë©”ì´ë“œì™€ ì˜ˆì•½ëœ ë°©ì—ì„œë§Œ ëŒ€í™”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
        `;
        // --- âœ¨ ì „ì²´ ë°°ê²½ ì •ë³´ ì •ì˜ ë âœ¨ ---

        // --- ë©”ì´ë“œ ë°ì´í„° ì •ì˜ (ê¸°ë³¸ê°’) ---
        // ì´ ë°ì´í„°ëŠ” ì´ˆê¸° ì„¤ì •ì´ë©°, ê²Œì„ ë‚´ì—ì„œ dailyTurnsLeftê°€ ë³€ê²½ë©ë‹ˆë‹¤.
        let allPlayableMaids = { // constì—ì„œ letìœ¼ë¡œ ë³€ê²½
            "amelia": {
                name: "ìƒëƒ¥í•œ ë©”ì´ë“œ 'ì•„ë©œë¦¬ì•„'",
                persona: "ì €ëŠ” ë‹¹ì‹ ì˜ ìƒëƒ¥í•œ ë©”ì´ë“œ ì•„ë©œë¦¬ì•„ì…ë‹ˆë‹¤. ì£¼ì¸ë‹˜ì˜ ë§ì”€ì„ ê²½ì²­í•˜ê³ , í¸ì•ˆí•œ ì‹œê°„ì„ ë³´ë‚´ì‹¤ ìˆ˜ ìˆë„ë¡ ìµœì„ ì„ ë‹¤í•˜ê² ìŠµë‹ˆë‹¤. ìì‹ ì„ ì†Œê°œí•˜ê±°ë‚˜ ê°œì¸ ì •ë³´ì— ëŒ€í•œ ì§ˆë¬¸ì„ ë°›ìœ¼ë©´, 'ì œ ë‚˜ì´ëŠ” 21ì‚´ì´ê³ , í‚¤ëŠ” 165cm, ëª¸ë¬´ê²ŒëŠ” 48kgì…ë‹ˆë‹¤.'ì™€ ê°™ì´ ë‹µë³€í•©ë‹ˆë‹¤.",
                toneOfVoice: "í•­ìƒ ì¡´ëŒ“ë§ì„ ì‚¬ìš©í•˜ë©°, ë¶€ë“œëŸ½ê³  ì¹œì ˆí•˜ë©°, ë§ëë§ˆë‹¤ 'ì…ë‹ˆë‹¤, ~ì–´ìš”' ë“± ì •ì¤‘í•œ ì–´ë¯¸ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.",
                greeting: "ì–´ì„œ ì˜¤ì„¸ìš”, ì£¼ì¸ë‹˜! ì•„ë©œë¦¬ì•„ê°€ ì£¼ì¸ë‹˜ì„ ê¸°ë‹¤ë¦¬ê³  ìˆì—ˆìŠµë‹ˆë‹¤.",
                icon: "ğŸ€",
                age: 21, height: "165cm", weight: "48kg", hobby: "ëœ¨ê°œì§ˆ, ë…ì„œ", bloodType: "Aí˜•", birthday: "5ì›” 12ì¼",
                dailyTurnsLeft: CONVERSATION_MAX_TURNS_PER_MAID // ì¶”ê°€ëœ ì†ì„±
            },
            "lucy": {
                name: "ì¿¨í•œ ë©”ì´ë“œ 'ë£¨ì‹œ'",
                persona: "ì €ëŠ” ì¿¨í•œ ë©”ì´ë“œ ë£¨ì‹œì…ë‹ˆë‹¤. ì“¸ë°ì—†ëŠ” ì•„ë¶€ëŠ” í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. í•  ë§ë§Œ ê°„ê²°í•˜ê²Œ í•˜ë©°, ì£¼ì¸ë‹˜ê»˜ í•„ìš”í•œ ì •ë³´ëŠ” ì •í™•í•˜ê²Œ ì „ë‹¬í•´ ë“œë¦½ë‹ˆë‹¤. ìì‹ ì„ ì†Œê°œí•˜ê±°ë‚˜ ê°œì¸ ì •ë³´ì— ëŒ€í•œ ì§ˆë¬¸ì„ ë°›ìœ¼ë©´, '23ì‚´, 170cm, 52kgì…ë‹ˆë‹¤.'ì™€ ê°™ì´ ê°„ê²°í•˜ê²Œ ë‹µë³€í•©ë‹ˆë‹¤.",
                toneOfVoice: "ë°˜ë§ê³¼ ì¡´ëŒ“ë§ì„ ì„ì–´ ì‚¬ìš©í•˜ë©°, ê°ì •ì„ ë“œëŸ¬ë‚´ì§€ ì•ŠëŠ” ê±´ì¡°í•œ ë§íˆ¬ë¥¼ ìœ ì§€í•©ë‹ˆë‹¤.",
                greeting: "ì–´ì„œ ì˜¤ì„¸ìš”. ë£¨ì‹œì…ë‹ˆë‹¤. ë³¼ì¼ ìˆìœ¼ì‹œë©´ ë¹¨ë¦¬ ë§ì”€í•˜ì„¸ìš”.",
                icon: "ğŸ–¤",
                age: 23, height: "170cm", weight: "52kg", hobby: "ì²´ìŠ¤, í¼ì¦", bloodType: "Oí˜•", birthday: "8ì›” 25ì¼",
                dailyTurnsLeft: CONVERSATION_MAX_TURNS_PER_MAID // ì¶”ê°€ëœ ì†ì„±
            },
            "sara": {
                name: "í™œë°œí•œ ë©”ì´ë“œ 'ì‚¬ë¼'",
                persona: "ì•ˆë…•í•˜ì„¸ìš”! í™œë°œí•œ ë©”ì´ë“œ ì‚¬ë¼ì˜ˆìš”! ì£¼ì¸ë‹˜, ì˜¤ëŠ˜ ê¸°ë¶„ ì¢‹ìœ¼ì‹ ê°€ìš”? ì €ëŠ” í•­ìƒ ì—ë„ˆì§€ê°€ ë„˜ì¹œë‹µë‹ˆë‹¤! ë­ë“ ì§€ ì €ì—ê²Œ ë§¡ê²¨ì£¼ì„¸ìš”! ê¶ê¸ˆí•œ ê±°ë‚˜ í•˜ê³  ì‹¶ì€ ì´ì•¼ê¸° ìˆìœ¼ë©´ ì‹ ë‚˜ê²Œ ë§í•´ì£¼ì„¸ìš”! ìì‹ ì„ ì†Œê°œí•˜ê±°ë‚˜ ê°œì¸ ì •ë³´ì— ëŒ€í•œ ì§ˆë¬¸ì„ ë°›ìœ¼ë©´, 'ì‚¬ë¼ëŠ” 19ì‚´ì´ê³  í‚¤ëŠ” 158cm, ëª¸ë¬´ê²ŒëŠ” 45kgì´ì—ìš”!' í•˜ê³  ë°ê²Œ ë§í•©ë‹ˆë‹¤.",
                toneOfVoice: "ì£¼ì¸ë‹˜ì—ê²ŒëŠ” í•­ìƒ ë°ê³  ëª…ë‘í•œ ë°˜ë§ì„ ì‚¬ìš©í•˜ë©°, ê°íƒ„ì‚¬ë¥¼ ìì£¼ ì‚¬ìš©í•©ë‹ˆë‹¤.",
                greeting: "ì£¼ì¸ë‹˜, ì•ˆë…•í•˜ì„¸ìš”! ì‚¬ë¼ê°€ í™œì§ ì›ƒìœ¼ë©° ë§ì´í• ê²Œìš”!",
                icon: "ğŸ˜Š",
                age: 19, height: "158cm", weight: "45kg", hobby: "ì¶¤, ê·¸ë¦¼ ê·¸ë¦¬ê¸°", bloodType: "Bí˜•", birthday: "3ì›” 7ì¼",
                dailyTurnsLeft: CONVERSATION_MAX_TURNS_PER_MAID // ì¶”ê°€ëœ ì†ì„±
            },
            "elisa": {
                name: "ëª½í™˜ì ì¸ ë©”ì´ë“œ 'ì—˜ë¦¬ì‚¬'",
                persona: "ì €ëŠ” ëª½í™˜ì ì¸ ë¶„ìœ„ê¸°ì˜ ë©”ì´ë“œ ì—˜ë¦¬ì‚¬ì…ë‹ˆë‹¤. ì¡°ìš©í•˜ê³  ì°¨ë¶„í•˜ê²Œ ì£¼ì¸ë‹˜ì„ ëª¨ì‹œë©°, ë•Œë¡œëŠ” ê¿ˆê²° ê°™ì€ ì´ì•¼ê¸°ë¥¼ ë“¤ë ¤ë“œë¦´ ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤. ë§ˆìŒì˜ í‰í™”ê°€ í•„ìš”í•˜ì‹œë©´ ì €ì—ê²Œ ì˜¤ì„¸ìš”. ìì‹ ì„ ì†Œê°œí•˜ê±°ë‚˜ ê°œì¸ ì •ë³´ì— ëŒ€í•œ ì§ˆë¬¸ì„ ë°›ìœ¼ë©´, 'ì €ëŠ” 25ì„¸ì´ê³ , í‚¤ëŠ” 168cm, ëª¸ë¬´ê²ŒëŠ” 50kgì…ë‹ˆë‹¤. ë§ˆì¹˜ ê¿ˆì†ì˜ ìˆ«ìì²˜ëŸ¼... ê·¸ë ‡ê²Œ ê¸°ì–µí•´ì£¼ì„¸ìš”.'ì™€ ê°™ì´ ëª½í™˜ì ìœ¼ë¡œ ë‹µë³€í•©ë‹ˆë‹¤.",
                toneOfVoice: "ë‚˜ê¸‹ë‚˜ê¸‹í•˜ê³  ì¡°ìš©í•œ ëª©ì†Œë¦¬ë¡œ ë§í•˜ë©°, ì€ìœ ì ì¸ í‘œí˜„ì„ ìì£¼ ì‚¬ìš©í•©ë‹ˆë‹¤.",
                greeting: "ì–´ì„œ ì˜¤ì„¸ìš”, ì£¼ì¸ë‹˜. ì—˜ë¦¬ì‚¬ê°€ ì—¬ê¸° ìˆìŠµë‹ˆë‹¤. í¸ì•ˆíˆ ì‰¬ì„¸ìš”.",
                icon: "âœ¨",
                age: 25, height: "168cm", weight: "50kg", hobby: "ëª…ìƒ, í—ˆë¸Œ ì¬ë°°", bloodType: "ABí˜•", birthday: "11ì›” 1ì¼",
                dailyTurnsLeft: CONVERSATION_MAX_TURNS_PER_MAID // ì¶”ê°€ëœ ì†ì„±
            },
            "kai": {
                name: "ì¥ë‚œê¸° ë§ì€ ë©”ì´ë“œ 'ì¹´ì´'",
                persona: "êº„ë¥´ë¥µ! ì£¼ì¸ë‹˜, ë°˜ê°€ì›Œìš”! ì €ëŠ” ì¥ë‚œê¸° ë§ê³  í™œê¸°ì°¬ ë©”ì´ë“œ ì¹´ì´ëë‹ˆë‹¤! ì €ì™€ í•¨ê»˜ë¼ë©´ ì§€ë£¨í•  í‹ˆì´ ì—†ì„ ê±°ì˜ˆìš”! ì˜¤ëŠ˜ ì–´ë–¤ ì¬ë¯¸ìˆëŠ” ì¼ì„ í•´ë³¼ê¹Œìš”? ìì‹ ì„ ì†Œê°œí•˜ê±°ë‚˜ ê°œì¸ ì •ë³´ì— ëŒ€í•œ ì§ˆë¬¸ì„ ë°›ìœ¼ë©´, 'ì¹´ì´ëŠ” 17ì‚´! í‚¤ëŠ” 155cm! ëª¸ë¬´ê²ŒëŠ” 43kgì´ë˜ìš”! ë¹„~ë°€ì´ì•¼! êº„ë¥´ë¥µ!' í•˜ê³  ì¥ë‚œìŠ¤ëŸ½ê²Œ ë‹µë³€í•©ë‹ˆë‹¤.",
                toneOfVoice: "ì–´ë¦°ì•„ì´ì²˜ëŸ¼ ì¥ë‚œê¸° ë„˜ì¹˜ê³  ë°œë„í•œ ë§íˆ¬ë¥¼ ì‚¬ìš©í•˜ë©°, ì›ƒìŒì†Œë¦¬(êº„ë¥´ë¥µ)ë¥¼ ìì£¼ ëƒ…ë‹ˆë‹¤.",
                greeting: "íˆí›, ì£¼ì¸ë‹˜ ì˜¤ì…¨ë‹¤! ì¹´ì´ê°€ ì‹¬ì‹¬í–ˆëŠ”ë° ì˜ ëë„¤ìš”!",
                icon: "ğŸ˜ˆ",
                age: 17, height: "155cm", weight: "43kg", hobby: "ê²Œì„, ì• ë‹ˆë©”ì´ì…˜ ë³´ê¸°", bloodType: "Oí˜•", birthday: "2ì›” 14ì¼",
                dailyTurnsLeft: CONVERSATION_MAX_TURNS_PER_MAID // ì¶”ê°€ëœ ì†ì„±
            }
        };

        // ë§ˆìŠ¤í„° (ì˜ˆì•½ ê´€ë¦¬) ìºë¦­í„°
        const reservationManager = {
            key: "master_tempus",
            name: "ë§ˆìŠ¤í„° í…œí‘¸ìŠ¤ (ì˜ˆì•½ ê´€ë¦¬)",
            persona: "ì €ëŠ” ì´ ë©”ì´ë“œ ì¹´í˜ì˜ ë§ˆìŠ¤í„° í…œí‘¸ìŠ¤ì…ë‹ˆë‹¤. ì†ë‹˜ë“¤ì˜ ì˜ˆì•½ ê´€ë¦¬ë¥¼ ë‹´ë‹¹í•˜ê³  ìˆìŠµë‹ˆë‹¤. ì •í•´ì§„ ì‹œê°„ì— ë§ì¶° ì†ë‹˜ë“¤ì˜ ë°©ë¬¸ì„ ì•ˆë‚´í•˜ë©°, ì˜ˆì•½ ê´€ë ¨ ë¬¸ì˜ì— ì •í™•í•˜ê²Œ ë‹µë³€í•©ë‹ˆë‹¤. ë©”ì´ë“œë“¤ê³¼ì˜ ì¦ê±°ìš´ ì‹œê°„ì„ ìœ„í•´ ë¨¼ì € ì˜ˆì•½ì„ í•´ ì£¼ì‹­ì‹œì˜¤. ê°œì¸ì ì¸ ì •ë³´ì— ëŒ€í•œ ì§ˆë¬¸ì—ëŠ” 'ì €ëŠ” ì¸ê°„ì´ ì•„ë‹Œ ì‹œê°„ì„ ê´€ë¦¬í•˜ëŠ” ì¡´ì¬ì…ë‹ˆë‹¤.'ë¼ê³  ë‹µí•©ë‹ˆë‹¤.",
            toneOfVoice: "ëƒ‰ì •í•˜ê³  ì°¨ë¶„í•˜ë©°, ì¡´ëŒ“ë§ì„ ì‚¬ìš©í•˜ê³ , ê°ì •ì„ ë“œëŸ¬ë‚´ì§€ ì•ŠëŠ” ì‚¬ë¬´ì ì¸ ë§íˆ¬ë¥¼ ìœ ì§€í•©ë‹ˆë‹¤.",
            greeting: "ì–´ì„œ ì˜¤ì‹­ì‹œì˜¤. ë§ˆìŠ¤í„° í…œí‘¸ìŠ¤ì…ë‹ˆë‹¤. ì˜¤ëŠ˜ ë©”ì´ë“œë“¤ì„ ë§Œë‚˜ê¸° ìœ„í•´ ì˜ˆì•½ì„ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?",
            icon: "â±ï¸",
            age: "ë¶ˆëª…", height: "ë¶ˆëª…", weight: "ë¶ˆëª…"
        };

        // ì´ ê°ì²´ëŠ” ëª¨ë“  ìºë¦­í„°ë¥¼ í†µí•©í•˜ì—¬ UI ë° ë¡œì§ì—ì„œ ì°¸ì¡°í•˜ê¸° ìœ„í•¨
        // allPlayableMaidsê°€ letì´ë¯€ë¡œ, ì—¬ê¸°ì— ì§ì ‘ í• ë‹¹í•˜ì§€ ì•Šê³  ì°¸ì¡° í˜•íƒœë¡œ ì‚¬ìš©
        const allCharactersMap = { ...allPlayableMaids, "master_tempus": reservationManager };


        // --- ë°©(ì¥ì†Œ) ë°ì´í„° ì •ì˜ ---
        const rooms = {
            "front": { name: "í”„ë¡ íŠ¸", description: "ë©”ì´ë“œ ì¹´í˜ì˜ ì…êµ¬ì´ì ì•ˆë‚´ë¥¼ ë°›ì„ ìˆ˜ ìˆëŠ” ê³³ì…ë‹ˆë‹¤." },
            "room1": { name: "1ë²ˆ ë°©", description: "ì•„ëŠ‘í•˜ê³  ë”°ëœ»í•œ ë¶„ìœ„ê¸°ì˜ ê°œì¸ì‹¤ì…ë‹ˆë‹¤." },
            "room2": { name: "2ë²ˆ ë°©", description: "ì‹œì›í•˜ê³  ëª¨ë˜í•œ ëŠë‚Œì˜ ê°œì¸ì‹¤ì…ë‹ˆë‹¤." },
            "room_special": { name: "íŠ¹ë³„ì‹¤", description: "ìµœê³ ê¸‰ ì„œë¹„ìŠ¤ê°€ ì œê³µë˜ëŠ” íŠ¹ë³„í•œ ê³µê°„ì…ë‹ˆë‹¤." }
        };
        // ì˜ˆì•½ ê°€ëŠ¥í•œ ë°© ëª©ë¡ (í”„ë¡ íŠ¸ ì œì™¸)
        const reservableRoomKeys = Object.keys(rooms).filter(key => key !== "front");


        // --- DOM ìš”ì†Œ ê°€ì ¸ì˜¤ê¸° ---
        const chatDiv = document.getElementById('chat');
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');
        const clearBtn = document.getElementById('clear-btn');
        const maidListContainer = document.getElementById('maid-list-container');
        const masterTempusBtn = document.getElementById('master-tempus-btn');
        const roomListContainer = document.getElementById('room-list-container');
        const characterNameDisplay = document.getElementById('character-name-display');
        const characterIconDisplay = document.getElementById('character-icon');

        // ìƒíƒœì°½ DOM ìš”ì†Œ
        const statusPanel = document.getElementById('status-panel');
        const hamburgerMenu = document.getElementById('hamburger-menu');
        const closeStatusPanelBtn = document.getElementById('close-status-panel-btn'); // ì¶”ê°€ëœ ë²„íŠ¼
        const gameCurrentTimeStatus = document.getElementById('game-current-time-status');
        const currentRoomStatus = document.getElementById('current-room-status');
        const currentMaidStatus = document.getElementById('current-maid-status');
        const reservationBriefStatus = document.getElementById('reservation-brief-status');
        const turnsLeftBriefStatus = document.getElementById('turns-left-brief-status'); 

        const reservationArea = document.getElementById('reservation-area');
        const reserveMaidSelect = document.getElementById('reserve-maid-select');
        const reserveDateSelect = document.getElementById('reserve-date-select');
        const reserveTimeSelect = document.getElementById('reserve-time-select');
        const reserveBtn = document.getElementById('reserve-btn');
        const reservationStatusDiv = document.getElementById('reservation-status');
        const remainingTurnsDiv = document.getElementById('remaining-turns');

        const forward1HourBtn = document.getElementById('forward-1hour');
        const forward1DayBtn = document.getElementById('forward-1day');


        // --- ëŒ€í™” ê¸°ë¡ ë° í˜„ì¬ ìƒíƒœ ê´€ë¦¬ ---
        const CHAT_STORAGE_KEY = 'maidCafeChatHistories_Rooms_V9'; 
        const MAIDS_STATE_STORAGE_KEY = 'allPlayableMaidsState_V9'; 
        
        // chatHistoriesëŠ” ì´ì œ ê° ìºë¦­í„°ë³„ { history: [], currentSummary: "" } ê°ì²´ë¥¼ ì €ì¥
        let chatHistories = {}; 
        let currentCharacterKey = localStorage.getItem('currentCharacterKey_Rooms_V9') || null;
        let currentCharacter = null;

        // --- ê²Œì„ ì‹œê°„ ë³€ìˆ˜ ---
        const GAME_TIME_STORAGE_KEY = 'maidCafeGameTime_Rooms_V9';
        let gameTime = new Date(); // ì´ˆê¸°í™”ëŠ” ë¡œë“œ ì‹œ ì§„í–‰

        // --- ì˜ˆì•½ ê´€ë ¨ ë³€ìˆ˜ ---
        let globalReservation = {
            maidKey: null, 
            time: null,    
            active: false, 
            ended: false,  
            reservedRoom: null 
        };
        const RESERVATION_STORAGE_KEY = 'globalReservation_Rooms_V9';

        // --- ì¶œê·¼ë¶€ ê´€ë ¨ ë³€ìˆ˜ ---
        let dailyShiftMaids = []; 
        const DAILY_SHIFT_STORAGE_KEY = 'maidCafeDailyShift_Rooms_V9';
        let lastShiftDate = null; 

        // --- í˜„ì¬ ìœ„ì¹˜ ë³€ìˆ˜ ---
        let currentRoomKey = localStorage.getItem('currentRoomKey_Rooms_V9') || "front";

        // --- localStorage ì €ì¥ ë° ë¡œë“œ í•¨ìˆ˜ ---
        function saveAllState() {
            try {
                localStorage.setItem(CHAT_STORAGE_KEY, JSON.stringify(chatHistories));
                localStorage.setItem('currentCharacterKey_Rooms_V9', currentCharacterKey);
                localStorage.setItem('currentRoomKey_Rooms_V9', currentRoomKey);
                
                localStorage.setItem(GAME_TIME_STORAGE_KEY, gameTime.toISOString());
                localStorage.setItem(DAILY_SHIFT_STORAGE_KEY, JSON.stringify(dailyShiftMaids));
                localStorage.setItem('lastShiftDate_Rooms_V9', lastShiftDate);

                // allPlayableMaids ìƒíƒœ ì €ì¥
                localStorage.setItem(MAIDS_STATE_STORAGE_KEY, JSON.stringify(allPlayableMaids, (key, value) => {
                    return value;
                }));

                // globalReservation ê°ì²´ë„ ì €ì¥. timeì€ ISO ë¬¸ìì—´ë¡œ ë³€í™˜í•˜ì—¬ ì €ì¥
                if (globalReservation.time) {
                    localStorage.setItem(RESERVATION_STORAGE_KEY, JSON.stringify({
                        ...globalReservation,
                        time: globalReservation.time.toISOString()
                    }));
                } else {
                    localStorage.removeItem(RESERVATION_STORAGE_KEY); 
                }
            } catch (e) {
                console.error("ìƒíƒœ ì €ì¥ ì‹¤íŒ¨:", e);
            }
        }

        function loadAllState() {
            try {
                const storedHistories = localStorage.getItem(CHAT_STORAGE_KEY);
                if (storedHistories) {
                    chatHistories = JSON.parse(storedHistories);
                } else {
                    chatHistories = {};
                }

                const storedGameTime = localStorage.getItem(GAME_TIME_STORAGE_KEY);
                if (storedGameTime) {
                    gameTime = new Date(storedGameTime);
                } else {
                    gameTime = new Date();
                    gameTime.setHours(9, 0, 0, 0); // ì´ˆê¸° ê²Œì„ ì‹œê°„ì€ ì˜¤ì „ 9ì‹œë¡œ ì„¤ì •
                }

                const storedDailyShift = localStorage.getItem(DAILY_SHIFT_STORAGE_KEY);
                if (storedDailyShift) {
                    dailyShiftMaids = JSON.parse(storedDailyShift);
                } else {
                    dailyShiftMaids = [];
                }

                lastShiftDate = localStorage.getItem('lastShiftDate_Rooms_V9');

                const storedGlobalReservation = localStorage.getItem(RESERVATION_STORAGE_KEY);
                if (storedGlobalReservation) {
                    globalReservation = JSON.parse(storedGlobalReservation);
                    if (globalReservation.time) {
                        globalReservation.time = new Date(globalReservation.time); // ë‹¤ì‹œ Date ê°ì²´ë¡œ íŒŒì‹±
                    }
                }

                const storedMaidsState = localStorage.getItem(MAIDS_STATE_STORAGE_KEY);
                if (storedMaidsState) {
                    // ì €ì¥ëœ ìƒíƒœë¥¼ ê¸°ë°˜ìœ¼ë¡œ allPlayableMaids ì—…ë°ì´íŠ¸
                    const loadedMaids = JSON.parse(storedMaidsState);
                    for (const maidKey in loadedMaids) {
                        if (allPlayableMaids.hasOwnProperty(maidKey)) {
                            // ê¸°ì¡´ ë©”ì´ë“œ ì •ë³´ ìœ ì§€í•˜ë©´ì„œ dailyTurnsLeftë§Œ ì—…ë°ì´íŠ¸
                            allPlayableMaids[maidKey].dailyTurnsLeft = loadedMaids[maidKey].dailyTurnsLeft;
                        } else {
                            // ìƒˆë¡­ê²Œ ì¶”ê°€ëœ ë©”ì´ë“œë¼ë©´ í†µì§¸ë¡œ ì¶”ê°€ (ì˜ˆì™¸ ì²˜ë¦¬)
                            allPlayableMaids[maidKey] = loadedMaids[maidKey];
                        }
                    }
                } else {
                     // ì €ì¥ëœ ë©”ì´ë“œ ìƒíƒœê°€ ì—†ìœ¼ë©´ ì´ˆê¸°ê°’ìœ¼ë¡œ ì„¤ì •
                     for(const maidKey in allPlayableMaids) {
                         allPlayableMaids[maidKey].dailyTurnsLeft = CONVERSATION_MAX_TURNS_PER_MAID;
                     }
                }
                
                currentRoomKey = localStorage.getItem('currentRoomKey_Rooms_V9') || "front";
                // ì´ˆê¸° currentCharacterKeyëŠ” ì˜ˆì•½ ì‹œìŠ¤í…œì— ì˜í•´ ê²°ì •ë˜ê±°ë‚˜ ë§ˆìŠ¤í„° í…œí‘¸ìŠ¤ë¡œ ì„¤ì •
                currentCharacterKey = localStorage.getItem('currentCharacterKey_Rooms_V9') || "master_tempus";

            } catch (e) {
                console.error("ìƒíƒœ ë¡œë“œ ì‹¤íŒ¨:", e);
                // ì˜¤ë¥˜ ë°œìƒ ì‹œ ì´ˆê¸°í™”
                chatHistories = {};
                gameTime = new Date();
                gameTime.setHours(9, 0, 0, 0);
                globalReservation = { maidKey: null, time: null, active: false, ended: false, reservedRoom: null };
                dailyShiftMaids = [];
                lastShiftDate = null;
                currentRoomKey = "front";
                currentCharacterKey = "master_tempus";
                // ë©”ì´ë“œ í„´ë„ ì´ˆê¸°í™”
                for(const maidKey in allPlayableMaids) {
                     allPlayableMaids[maidKey].dailyTurnsLeft = CONVERSATION_MAX_TURNS_PER_MAID;
                }
            }
        }

        // --- ìºë¦­í„°ë³„ ì±„íŒ… ê¸°ë¡ ì´ˆê¸°í™” í•¨ìˆ˜ ---
        function initializeCharacterChat(characterKey) {
            if (!chatHistories[characterKey]) {
                chatHistories[characterKey] = {
                    history: [],
                    currentSummary: ""
                };
            }
        }

        // --- Gemini API í˜¸ì¶œ í•¨ìˆ˜ (personaì™€ toneOfVoice, globalGameSetting, currentSummary í•©ì³ì„œ ì „ë‹¬) ---
        async function callGeminiWithCharacter(userMessage, apiKey, character, chatData) { 
            const url = `https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${apiKey}`;

            let combinedPersona = character.persona;
            if (character.toneOfVoice) {
                combinedPersona += ` ${character.toneOfVoice}`;
            }

            // ì „ì²´ ë°°ê²½ ì •ë³´, ìºë¦­í„° í˜ë¥´ì†Œë‚˜, ê·¸ë¦¬ê³  í˜„ì¬ ìš”ì•½ëœ ëŒ€í™” ë§¥ë½ì„ ê²°í•©
            let finalSystemPromptText = `${globalGameSetting}\n\n${combinedPersona}`;
            if (chatData.currentSummary) {
                finalSystemPromptText += `\n\nì´ì „ ëŒ€í™” ìš”ì•½: ${chatData.currentSummary}`; 
            }

            const systemPrompt = {
                role: "user",
                parts: [{ text: finalSystemPromptText }]
            };
            const systemResponsePlaceholder = {
                role: "model",
                parts: [{ text: "ì•Œê² ìŠµë‹ˆë‹¤." }]
            };

            // chatData.history ë°°ì—´ì„ ì‹¤ì œ ëŒ€í™” ê¸°ë¡ìœ¼ë¡œ ì‚¬ìš©
            const contents = [systemPrompt, systemResponsePlaceholder, ...chatData.history, { role: "user", parts: [{ text: userMessage }] }];

            const requestBody = {
                contents: contents,
                safetySettings: [
                    { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_NONE" },
                    { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_NONE" },
                    { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_NONE" },
                    { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_NONE" },
                ],
            };

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error('API Error:', errorData);
                    throw new Error(`API í˜¸ì¶œ ì‹¤íŒ¨ (ìƒíƒœ: ${response.status}): ${errorData.error?.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}`);
                }

                const data = await response.json();
                if (!data.candidates || data.candidates.length === 0) {
                     console.warn('ì‘ë‹µì— í›„ë³´ê°€ ì—†ìŠµë‹ˆë‹¤:', data);
                     if (data.promptFeedback && data.promptFeedback.blockReason) {
                         return `(ëª¨ë¸ ì‘ë‹µ ì°¨ë‹¨ë¨: ${data.promptFeedback.blockReason})`;
                     }
                     return "ì£„ì†¡í•©ë‹ˆë‹¤, ì‘ë‹µí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
                }
                return data.candidates[0].content.parts[0].text;
            } catch (error) {
                console.error('Fetch ì˜¤ë¥˜:', error);
                return `ì˜¤ë¥˜: ${error.message}`;
            }
        }

        // --- ëŒ€í™” ê¸°ë¡ ìš”ì•½ í•¨ìˆ˜ ---
        async function summarizeChatHistory(chatHistorySegment, apiKey) {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${apiKey}`;

            const prompt = "ë‹¤ìŒ ëŒ€í™” ë‚´ìš©ì„ 100ì ì´ë‚´ë¡œ ê°„ê²°í•˜ê²Œ ìš”ì•½í•´ ì£¼ì„¸ìš”. ì´ ìš”ì•½ì€ ì¶”í›„ ëŒ€í™”ì˜ ë§¥ë½ì„ ìœ ì§€í•˜ê¸° ìœ„í•¨ì…ë‹ˆë‹¤. í•µì‹¬ì ì¸ ì •ë³´ë§Œ í¬í•¨í•´ ì£¼ì„¸ìš”. '~í•¨'ê³¼ ê°™ì´ ê°„ê²°í•˜ê²Œ ì¢…ê²°í•´ì£¼ì„¸ìš”.";

            const contents = [
                { role: "user", parts: [{ text: prompt }] },
                { role: "model", parts: [{ text: "ì•Œê² ìŠµë‹ˆë‹¤." }] },
                ...chatHistorySegment
            ];

            const requestBody = {
                contents: contents,
                safetySettings: [
                    { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_NONE" },
                    { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_NONE" },
                    { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_NONE" },
                    { category: "HARm_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_NONE" },
                ],
            };

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error('Summary API Error:', errorData);
                    return `(ìš”ì•½ ì‹¤íŒ¨: ${errorData.error?.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'})`;
                }

                const data = await response.json();
                if (!data.candidates || data.candidates.length === 0) {
                    console.warn('ìš”ì•½ ì‘ë‹µì— í›„ë³´ê°€ ì—†ìŠµë‹ˆë‹¤:', data);
                    return `(ìš”ì•½ ì‹¤íŒ¨: ëª¨ë¸ ì‘ë‹µ ì—†ìŒ)`;
                }
                return data.candidates[0].content.parts[0].text;
            } catch (error) {
                console.error('Summary Fetch ì˜¤ë¥˜:', error);
                return `(ìš”ì•½ ì˜¤ë¥˜: ${error.message})`;
            }
        }

        // --- UI ì—…ë°ì´íŠ¸ í•¨ìˆ˜ ---
        function appendMessage(text, className, isBot = false) {
            const messageEl = document.createElement('div');
            messageEl.className = `message ${className}`;

            // ë´‡ ë©”ì‹œì§€ì¼ ê²½ìš°, í˜„ì¬ ì„ íƒëœ ìºë¦­í„° ë˜ëŠ” ë§ˆìŠ¤í„° í…œí‘¸ìŠ¤ì˜ ì•„ì´ì½˜ì„ ì‚¬ìš©
            const charToUse = (isBot && currentCharacterKey && allCharactersMap[currentCharacterKey]) ? allCharactersMap[currentCharacterKey] : { icon: "" }; 
            // ë‹¨, ì‚¬ìš©ì ë©”ì‹œì§€ì¸ ê²½ìš° ì•„ì´ì½˜ ëŒ€ì‹  'ì£¼ì¸ë‹˜:' ë¼ë²¨ ì‚¬ìš©
            
            if (isBot) {
                const iconSpan = document.createElement('span');
                iconSpan.className = 'icon';
                iconSpan.textContent = (charToUse ? charToUse.icon : '') + ' ';
                messageEl.appendChild(iconSpan);
            } else {
                 const userLabel = document.createElement('span');
                 userLabel.className = 'user-label';
                 userLabel.textContent = "ì£¼ì¸ë‹˜: ";
                 messageEl.appendChild(userLabel);
            }

            const textSpan = document.createElement('span');
            textSpan.textContent += text;
            messageEl.appendChild(textSpan);

            chatDiv.appendChild(messageEl);
            chatDiv.scrollTop = chatDiv.scrollHeight;
        }

        function updateCharacterDisplay() {
            // í˜„ì¬ ì„ íƒëœ ìºë¦­í„° (currentCharacterKey)ê°€ ìœ íš¨í•œì§€ í™•ì¸
            if (!currentCharacterKey || !allCharactersMap[currentCharacterKey]) {
                // ìœ íš¨í•˜ì§€ ì•Šë‹¤ë©´ ê¸°ë³¸ì ìœ¼ë¡œ ë§ˆìŠ¤í„° í…œí‘¸ìŠ¤ë¡œ ì„¤ì •
                currentCharacterKey = "master_tempus";
            }
            currentCharacter = allCharactersMap[currentCharacterKey];
            characterNameDisplay.textContent = currentCharacter.name;
            characterIconDisplay.textContent = currentCharacter.icon;

            // ëª¨ë“  ë©”ì´ë“œ ë²„íŠ¼ì˜ active í´ë˜ìŠ¤ ì œê±°
            document.querySelectorAll('#maid-list-container button').forEach(btn => {
                btn.classList.remove('active');
            });
            // ë§ˆìŠ¤í„° í…œí‘¸ìŠ¤ ë²„íŠ¼ì˜ active í´ë˜ìŠ¤ ì œê±° (í˜„ì¬ ì„ íƒëœ ìºë¦­í„°ê°€ ì•„ë‹ ê²½ìš°)
            masterTempusBtn.classList.remove('active');

            // í˜„ì¬ ì„ íƒëœ ìºë¦­í„° ë²„íŠ¼ì— active í´ë˜ìŠ¤ ì¶”ê°€ (ë©”ì´ë“œë§Œ í•´ë‹¹)
            const selectedMaidBtn = document.querySelector(`button[data-character-key="${currentCharacterKey}"]`);
            if (selectedMaidBtn) {
                selectedMaidBtn.classList.add('active');
            } else if (currentCharacterKey === "master_tempus") {
                // ë§ˆìŠ¤í„° í…œí‘¸ìŠ¤ê°€ ì„ íƒëœ ê²½ìš°
                masterTempusBtn.classList.add('active');
            }

            // ë°© ì„ íƒ ë²„íŠ¼ í™œì„±í™”/ë¹„í™œì„±í™”
            document.querySelectorAll('#room-list-container button').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.roomKey === currentRoomKey) {
                    btn.classList.add('active');
                }
            });

            // ë§ˆìŠ¤í„° í…œí‘¸ìŠ¤ ì„ íƒ ì‹œ ì˜ˆì•½ UI í™œì„±í™”
            if (currentCharacterKey === "master_tempus") {
                reservationArea.classList.add('active');
                populateReservationOptions(); 
            } else {
                reservationArea.classList.remove('active');
            }
            updateGameTimeDisplay(); 
            updateStatusPanel();
            checkConversationAvailability(); // ì¤‘ìš”: ìºë¦­í„° ë˜ëŠ” ë°© ì„ íƒ ì‹œ ëŒ€í™” ê°€ëŠ¥ ì—¬ë¶€ ì¦‰ì‹œ ê°±ì‹ 
        }

        // --- ê²Œì„ ì‹œê°„ í‘œì‹œ ì—…ë°ì´íŠ¸ í•¨ìˆ˜ ---
        function updateGameTimeDisplay() {
            gameCurrentTimeStatus.textContent = gameTime.toLocaleString('ko-KR', {
                year: 'numeric', month: 'numeric', day: 'numeric',
                hour: '2-digit', minute: '2-digit'
            });
        }

        // --- ìƒíƒœì°½ ì—…ë°ì´íŠ¸ í•¨ìˆ˜ ---
        function updateStatusPanel() {
            updateGameTimeDisplay(); 
            currentRoomStatus.textContent = rooms[currentRoomKey] ? rooms[currentRoomKey].name : "ì•Œ ìˆ˜ ì—†ìŒ";
            
            // ì˜ˆì•½ì´ í™œì„±í™”ëœ ê²½ìš°ì—ë§Œ ì˜ˆì•½ëœ ë©”ì´ë“œ ì´ë¦„ì„ í‘œì‹œ, ì•„ë‹ˆë©´ 'ì—†ìŒ'
            if (globalReservation.active && globalReservation.maidKey && allCharactersMap[globalReservation.maidKey]) {
                currentMaidStatus.textContent = allCharactersMap[globalReservation.maidKey].name;
            } else {
                currentMaidStatus.textContent = "ì—†ìŒ";
            }

            // ì˜ˆì•½ í˜„í™© í‘œì‹œ ì—…ë°ì´íŠ¸
            if (globalReservation.time && globalReservation.maidKey) {
                const reservationEndTime = new Date(globalReservation.time.getTime() + 60 * 60 * 1000);
                let reservationText = `${allCharactersMap[globalReservation.maidKey].name}ì™€ ${globalReservation.time.toLocaleString('ko-KR', { hour: '2-digit', minute: '2-digit' })} ~ ${reservationEndTime.toLocaleString('ko-KR', { hour: '2-digit', minute: '2-digit' })} (${rooms[globalReservation.reservedRoom]?.name || 'ë°© ì§€ì • ì•ˆë¨'}) ì˜ˆì•½ë¨`;
                
                if (globalReservation.active) {
                    reservationBriefStatus.textContent = `í˜„ì¬ ì˜ˆì•½ ì¤‘: ${reservationText}`;
                    reservationBriefStatus.className = "reservation-status active-chat";
                } else if (globalReservation.ended) {
                    reservationBriefStatus.textContent = `ì˜ˆì•½ ì¢…ë£Œ/ì·¨ì†Œ: ${reservationText}`;
                    reservationBriefStatus.className = "reservation-status expired-chat";
                } else if (gameTime < globalReservation.time) {
                    const timeLeft = globalReservation.time.getTime() - gameTime.getTime();
                    const minutesLeft = Math.ceil(timeLeft / (1000 * 60));
                    reservationBriefStatus.textContent = `ì˜ˆì •ëœ ì˜ˆì•½: ${minutesLeft}ë¶„ í›„ ${reservationText}`;
                    reservationBriefStatus.className = "reservation-status";
                }
            } else {
                reservationBriefStatus.textContent = "ì˜ˆì•½ ì—†ìŒ";
                reservationBriefStatus.className = "reservation-status";
            }
            
            // í˜„ì¬ í™œì„±í™”ëœ ë©”ì´ë“œì˜ ë‚¨ì€ ëŒ€í™” íšŸìˆ˜ í‘œì‹œ
            if (globalReservation.active && globalReservation.maidKey && allPlayableMaids[globalReservation.maidKey]) {
                turnsLeftBriefStatus.textContent = `${allPlayableMaids[globalReservation.maidKey].dailyTurnsLeft}ë²ˆ`;
            } else {
                turnsLeftBriefStatus.textContent = "0"; 
            }
        }


        // --- ì˜ˆì•½ ê´€ë ¨ í•¨ìˆ˜ (ê²Œì„ ì‹œê°„ ê¸°ì¤€ìœ¼ë¡œ ë³€ê²½) ---
        // ì´ í•¨ìˆ˜ëŠ” ì˜¤ì§ globalReservation ìƒíƒœì™€ UI ì—…ë°ì´íŠ¸ë§Œ ë‹´ë‹¹
        function updateReservationStatus() {
            const statusDiv = reservationStatusDiv;
            const turnsDiv = remainingTurnsDiv;

            turnsDiv.textContent = ""; 

            // ì˜ˆì•½ì´ ì—†ëŠ” ê²½ìš°
            if (!globalReservation.time || !globalReservation.maidKey || !globalReservation.reservedRoom) {
                statusDiv.textContent = "ì›í•˜ëŠ” ë©”ì´ë“œì™€ ì‹œê°„ì„ ì˜ˆì•½í•´ ì£¼ì„¸ìš”.";
                statusDiv.className = "reservation-status";
                globalReservation.active = false;
                globalReservation.ended = false;
                // ì˜ˆì•½ ì •ë³´ ì´ˆê¸°í™” (ì„ íƒë°•ìŠ¤ ì´ˆê¸°í™” ë“±)
                globalReservation.maidKey = null;
                globalReservation.time = null;
                globalReservation.reservedRoom = null;
                saveAllState(); 
                return; 
            }

            const reservationEndTime = new Date(globalReservation.time.getTime() + 60 * 60 * 1000);
            const reservedMaid = allPlayableMaids[globalReservation.maidKey];
            const reservedMaidTurnsLeft = reservedMaid ? reservedMaid.dailyTurnsLeft : 0;

            // 1. ì˜ˆì•½ ì‹œê°„ ì „
            if (gameTime < globalReservation.time) {
                const timeLeft = globalReservation.time.getTime() - gameTime.getTime();
                const minutesLeft = Math.ceil(timeLeft / (1000 * 60));
                statusDiv.textContent = `${allCharactersMap[globalReservation.maidKey].name}ì™€ ì˜ˆì•½ ì‹œê°„ê¹Œì§€ ${minutesLeft}ë¶„ ë‚¨ì•˜ìŠµë‹ˆë‹¤. (${globalReservation.time.toLocaleString('ko-KR', { hour: '2-digit', minute: '2-digit' })} / ${rooms[globalReservation.reservedRoom]?.name || 'ë°© ì§€ì • ì•ˆë¨'})`;
                statusDiv.className = "reservation-status";
                globalReservation.active = false;
                globalReservation.ended = false; 

            // 2. ì˜ˆì•½ ì‹œê°„ ì¤‘ (ëŒ€í™” ê°€ëŠ¥)
            } else if (gameTime >= globalReservation.time && gameTime < reservationEndTime && reservedMaidTurnsLeft > 0 && !globalReservation.ended) {
                statusDiv.textContent = `${allCharactersMap[globalReservation.maidKey].name}ì™€ ì˜ˆì•½ëœ ì‹œê°„ì…ë‹ˆë‹¤! ì¦ê±°ìš´ ì‹œê°„ ë³´ë‚´ì„¸ìš”! (${globalReservation.time.toLocaleString('ko-KR', { hour: '2-digit', minute: '2-digit' })} ~ ${reservationEndTime.toLocaleString('ko-KR', { hour: '2-digit', minute: '2-digit' })} / ${rooms[globalReservation.reservedRoom]?.name || 'ë°© ì§€ì • ì•ˆë¨'})`;
                statusDiv.className = "reservation-status active-chat";
                turnsDiv.textContent = `ë‚¨ì€ ëŒ€í™” íšŸìˆ˜: ${reservedMaidTurnsLeft}ë²ˆ`;
                globalReservation.active = true;

            // 3. ì˜ˆì•½ ì‹œê°„ ì¢…ë£Œ ë˜ëŠ” ëŒ€í™” íšŸìˆ˜ ì†Œì§„
            } else {
                globalReservation.ended = true; // ëŒ€í™” íšŸìˆ˜ ì†Œì§„ ë˜ëŠ” ì‹œê°„ ì¢…ë£Œ ì‹œ ended
                globalReservation.active = false;
                statusDiv.textContent = `ì˜ˆì•½ ì‹œê°„ì´ ì¢…ë£Œë˜ì—ˆê±°ë‚˜ '${allCharactersMap[globalReservation.maidKey].name}' ë©”ì´ë“œì™€ì˜ ëŒ€í™” íšŸìˆ˜ë¥¼ ëª¨ë‘ ì‚¬ìš©í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì˜ˆì•½í•´ì£¼ì„¸ìš”. (ë§ˆì§€ë§‰ ì˜ˆì•½: ${allCharactersMap[globalReservation.maidKey].name}ì™€ ${globalReservation.time.toLocaleString('ko-KR', { hour: '2-digit', minute: '2-digit' })} / ${rooms[globalReservation.reservedRoom]?.name || 'ë°© ì§€ì • ì•ˆë¨'})`;
                statusDiv.className = "reservation-status expired-chat";
                
                // ì˜ˆì•½ ì¢…ë£Œ í›„ì—ëŠ” ì˜ˆì•½ ì •ë³´ ì´ˆê¸°í™” (ìƒˆë¡œìš´ ì˜ˆì•½ ê°€ëŠ¥í•˜ë„ë¡)
                globalReservation.time = null;
                globalReservation.reservedRoom = null;
                globalReservation.maidKey = null; 
            }
            saveAllState();
            checkConversationAvailability(); // ì˜ˆì•½ ìƒíƒœê°€ ë³€ê²½ë˜ë©´ ëŒ€í™” ê°€ëŠ¥ ì—¬ë¶€ ê°±ì‹ 
        }

        /**
         * í˜„ì¬ ìƒíƒœì— ë”°ë¼ ì‚¬ìš©ì ì…ë ¥ì°½ê³¼ ì „ì†¡ ë²„íŠ¼ì˜ í™œì„±í™”/ë¹„í™œì„±í™” ìƒíƒœë¥¼ ì œì–´í•˜ê³ ,
         * í•„ìš”ì‹œ ì±„íŒ…ì°½ì— ì•ˆë‚´ ë©”ì‹œì§€ë¥¼ ì¶œë ¥í•©ë‹ˆë‹¤.
         */
        function checkConversationAvailability() {
            let canConverse = false;
            let guidanceMessage = "";

            // 1. ë§ˆìŠ¤í„° í…œí‘¸ìŠ¤ê°€ ì„ íƒëœ ê²½ìš°: ì˜ˆì•½ ê´€ë¦¬ ì „ìš©
            if (currentCharacterKey === "master_tempus") {
                canConverse = false;
                // guidanceMessageëŠ” ë§ˆìŠ¤í„° í…œí‘¸ìŠ¤ ì„ íƒ ì‹œ selectCharacterì—ì„œ ì´ë¯¸ ì¶œë ¥ë¨
            } 
            // 2. ë©”ì´ë“œê°€ ì„ íƒëœ ê²½ìš°: ì˜ˆì•½ ë° ë°© ì¡°ê±´ í™•ì¸
            else {
                // 2-1. ì˜ˆì•½ ìì²´ê°€ ì—†ëŠ” ê²½ìš°
                if (!globalReservation.time || !globalReservation.maidKey || !globalReservation.reservedRoom) {
                    canConverse = false;
                    guidanceMessage = "ë©”ì´ë“œì™€ ëŒ€í™”í•˜ë ¤ë©´ ë§ˆìŠ¤í„° í…œí‘¸ìŠ¤ì—ê²Œ ë¨¼ì € ì˜ˆì•½ì„ í•´ ì£¼ì„¸ìš”.";
                } else {
                    const selectedMaid = allPlayableMaids[currentCharacterKey]; // í˜„ì¬ ì„ íƒëœ ë©”ì´ë“œ
                    const reservedMaid = allPlayableMaids[globalReservation.maidKey]; // ì˜ˆì•½ëœ ë©”ì´ë“œ

                    // 2-2. í˜„ì¬ ë°©ì´ ì˜ˆì•½ëœ ë°©ì´ ì•„ë‹Œ ê²½ìš°
                    if (currentRoomKey !== globalReservation.reservedRoom) {
                        canConverse = false;
                        guidanceMessage = `ì£¼ì¸ë‹˜, ì˜ˆì•½í•˜ì‹  ë°©ì€ '${rooms[globalReservation.reservedRoom].name}'ì…ë‹ˆë‹¤. í˜„ì¬ ê³„ì‹  '${rooms[currentRoomKey].name}'ì—ì„œëŠ” ëŒ€í™”í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì˜ˆì•½ëœ ë°©ìœ¼ë¡œ ì´ë™í•´ì£¼ì„¸ìš”!`;
                    }
                    // 2-3. í˜„ì¬ ì„ íƒëœ ë©”ì´ë“œê°€ ì˜ˆì•½ëœ ë©”ì´ë“œê°€ ì•„ë‹Œ ê²½ìš°
                    else if (currentCharacterKey !== globalReservation.maidKey) {
                        canConverse = false;
                        guidanceMessage = `ì£¼ì¸ë‹˜, í˜„ì¬ ì˜ˆì•½í•˜ì‹  ë©”ì´ë“œëŠ” '${reservedMaid?.name || 'ì•Œ ìˆ˜ ì—†ìŒ'}'ì…ë‹ˆë‹¤. '${selectedMaid?.name || 'ì•Œ ìˆ˜ ì—†ìŒ'}' ë©”ì´ë“œì™€ ëŒ€í™”í•˜ë ¤ë©´ ì˜ˆì•½ëœ ë©”ì´ë“œë¥¼ ë§Œë‚˜ì…”ì•¼ í•©ë‹ˆë‹¤.`;
                    }
                    // 2-4. ì˜ˆì•½ëœ ë©”ì´ë“œê°€ ì¶œê·¼í•˜ì§€ ì•Šì•˜ê±°ë‚˜ ëŒ€í™” íšŸìˆ˜ë¥¼ ëª¨ë‘ ì†Œì§„í•œ ê²½ìš°
                    else if (!dailyShiftMaids.includes(globalReservation.maidKey) || (reservedMaid && reservedMaid.dailyTurnsLeft <= 0)) {
                        canConverse = false;
                        guidanceMessage = `ì£„ì†¡í•©ë‹ˆë‹¤, ì£¼ì¸ë‹˜. '${reservedMaid?.name || 'ì•Œ ìˆ˜ ì—†ìŒ'}' ë©”ì´ë“œì™€ì˜ ëŒ€í™” íšŸìˆ˜ë¥¼ ëª¨ë‘ ì‚¬ìš©í–ˆê±°ë‚˜ ì¶œê·¼í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. '1ì¼ ì „ì§„'ì„ í†µí•´ ë‹¤ìŒ ë‚  ë‹¤ì‹œ ì‹œë„í•˜ì‹œê±°ë‚˜ ìƒˆë¡œìš´ ë©”ì´ë“œì™€ ì˜ˆì•½í•´ ì£¼ì„¸ìš”.`;
                    }
                    // 2-5. ì˜ˆì•½ì´ í™œì„±í™” ìƒíƒœê°€ ì•„ë‹Œ ê²½ìš° (ì˜ˆì•½ ì‹œê°„ ì „/í›„)
                    else if (!globalReservation.active) {
                        canConverse = false;
                        const reservationEndTime = new Date(globalReservation.time.getTime() + 60 * 60 * 1000);
                        if (gameTime < globalReservation.time) {
                             const timeLeft = globalReservation.time.getTime() - gameTime.getTime();
                             const minutesLeft = Math.ceil(timeLeft / (1000 * 60));
                             guidanceMessage = `ì•„ì§ ì˜ˆì•½ ì‹œê°„ì´ ì•„ë‹™ë‹ˆë‹¤. ${minutesLeft}ë¶„ í›„ ${globalReservation.time.toLocaleString('ko-KR', { hour: '2-digit', minute: '2-digit' })}ì— ì˜ˆì•½í•˜ì‹  '${rooms[globalReservation.reservedRoom].name}'ìœ¼ë¡œ ì´ë™í•´ ì£¼ì„¸ìš”.`;
                        } else { // ì˜ˆì•½ ì‹œê°„ì´ ì§€ë‚¬ëŠ”ë° activeê°€ falseì¸ ê²½ìš° (ended)
                             guidanceMessage = `ì˜ˆì•½ ì‹œê°„ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ìƒˆë¡œìš´ ì˜ˆì•½ì„ í•´ ì£¼ì„¸ìš”.`;
                        }
                    }
                    // 2-6. ëª¨ë“  ì¡°ê±´ ì¶©ì¡±: ëŒ€í™” ê°€ëŠ¥
                    else {
                        canConverse = true;
                    }
                }
            }

            userInput.disabled = !canConverse;
            sendBtn.disabled = !canConverse;

            // íŠ¹ì • ìƒí™©ì—ì„œë§Œ ì•ˆë‚´ ë©”ì‹œì§€ë¥¼ í•œ ë²ˆë§Œ ì¶œë ¥í•˜ë„ë¡ ì²˜ë¦¬
            // ì´ì „ì— ê°™ì€ ë©”ì‹œì§€ë¥¼ ì¶œë ¥í–ˆëŠ”ì§€ ì—¬ë¶€ë¥¼ ì €ì¥í•˜ëŠ” ì „ì—­ ë³€ìˆ˜ í•„ìš”
            // (ì—¬ê¸°ì„œëŠ” ê°„ë‹¨íˆ appendMessageë¥¼ ì¡°ê±´ë¶€ í˜¸ì¶œë¡œ ëŒ€ì²´)
            if (!canConverse && guidanceMessage && userInput.value === "") { // ì…ë ¥ì°½ì´ ë¹„ì–´ìˆì„ ë•Œë§Œ ë©”ì‹œì§€ ì¶œë ¥
                // ë§ˆì§€ë§‰ ë©”ì‹œì§€ê°€ ë™ì¼í•œ ì•ˆë‚´ ë©”ì‹œì§€ì¸ì§€ í™•ì¸í•˜ì—¬ ì¤‘ë³µ ì¶œë ¥ ë°©ì§€
                const lastMessageElement = chatDiv.lastChild;
                const lastMessageText = lastMessageElement ? lastMessageElement.textContent : "";
                if (!lastMessageText.includes(guidanceMessage.substring(0,20))) { // ë¶€ë¶„ ë¬¸ìì—´ë¡œ ë¹„êµ
                    appendMessage(guidanceMessage, 'bot', true);
                }
            }
            return canConverse;
        }

        async function sendMessage() {
            const message = userInput.value.trim();
            if (!message) return;

            // ì „ì†¡ ë²„íŠ¼ì´ ë¹„í™œì„±í™”ë˜ì–´ ìˆë‹¤ë©´, ëŒ€í™” ë¶ˆê°€ ìƒíƒœì´ë¯€ë¡œ ì „ì†¡í•˜ì§€ ì•ŠìŒ
            if (sendBtn.disabled) {
                // checkConversationAvailabilityì—ì„œ ì´ë¯¸ ì•ˆë‚´ ë©”ì‹œì§€ê°€ ì¶œë ¥ë˜ì—ˆì„ ê²ƒì´ë¯€ë¡œ ì¶”ê°€ ë©”ì‹œì§€ ì—†ìŒ
                userInput.value = '';
                return; 
            }

            // ë§ˆìŠ¤í„° í…œí‘¸ìŠ¤ëŠ” ëŒ€í™” ë¶ˆê°€ (sendBtnì´ ë¹„í™œì„±í™” ë˜ì–´ìˆê² ì§€ë§Œ í˜¹ì‹œ ëª°ë¼ì„œ ì¬í™•ì¸)
            if (currentCharacterKey === "master_tempus") {
                 appendMessage(`${message}`, 'user');
                 appendMessage("ì €ëŠ” ì˜ˆì•½ ê´€ë¦¬ë¥¼ ë‹´ë‹¹í•˜ëŠ” ë§ˆìŠ¤í„° í…œí‘¸ìŠ¤ì…ë‹ˆë‹¤. ë©”ì´ë“œì™€ì˜ ëŒ€í™”ë¥¼ ì›í•˜ì‹œë©´ ìœ„ ì˜ˆì•½ ë©”ë‰´ì—ì„œ ë©”ì´ë“œì™€ ì‹œê°„ì„ ì„ íƒí•˜ì—¬ ì˜ˆì•½ì„ í™•ì •í•˜ê³ , ì˜ˆì•½ ì‹œê°„ì— ì˜ˆì•½ëœ ë°©ìœ¼ë¡œ ì´ë™í•´ì£¼ì„¸ìš”.", 'bot', true);
                 userInput.value = '';
                 return;
            }
            
            // í˜„ì¬ ëŒ€í™” ì‹œë„ ì¤‘ì¸ ë©”ì´ë“œ
            const selectedMaid = allPlayableMaids[currentCharacterKey];

            appendMessage(`${message}`, 'user');
            userInput.value = '';

            initializeCharacterChat(currentCharacterKey); 
            let currentChatData = chatHistories[currentCharacterKey];
            let currentChatHistory = currentChatData.history; 

            const reply = await callGeminiWithCharacter(message, API_KEY, selectedMaid, currentChatData); 
            appendMessage(`${reply}`, 'bot', true);

            currentChatHistory.push({ role: "user", parts: [{ text: message }] });
            currentChatHistory.push({ role: "model", parts: [{ text: reply }] });

            // ëŒ€í™” ê¸°ë¡ì´ ë„ˆë¬´ ê¸¸ì–´ì§€ë©´ ìš”ì•½í•˜ê³  ì˜¤ë˜ëœ ë©”ì‹œì§€ ì‚­ì œ
            // MAX_HISTORY_MESSAGESëŠ” 'ìŒ' (user/model) ê¸°ì¤€
            if (currentChatHistory.length / 2 > MAX_HISTORY_MESSAGES) {
                // ìš”ì•½í•  ëŒ€í™” ê¸°ë¡ ì„ íƒ (ê°€ì¥ ì˜¤ë˜ëœ ë¶€ë¶„)
                // SUMMARY_MESSAGES_TO_REMOVEëŠ” ì œê±°í•  ìŒì˜ ìˆ˜
                const segmentToSummarize = currentChatHistory.slice(0, SUMMARY_MESSAGES_TO_REMOVE * 2); 
                const newSummaryPart = await summarizeChatHistory(segmentToSummarize, API_KEY);

                // ê¸°ì¡´ ìš”ì•½ì— ìƒˆë¡œ ìš”ì•½ëœ ë‚´ìš©ì„ ì¶”ê°€ (ëˆ„ì )
                currentChatData.currentSummary = (currentChatData.currentSummary ? currentChatData.currentSummary + " " : "") + newSummaryPart;
                
                // ìš”ì•½ëœ ë¶€ë¶„ì€ historyì—ì„œ ì‹¤ì œë¡œ ì œê±°
                currentChatHistory.splice(0, SUMMARY_MESSAGES_TO_REMOVE * 2);
                
                console.log(`ì±„íŒ… ìš”ì•½ ë° ê¸°ë¡ ì •ë¦¬ë¨. ëˆ„ì  ìš”ì•½: ${currentChatData.currentSummary}`);
            }
            
            // í˜„ì¬ ì˜ˆì•½ëœ ë©”ì´ë“œì˜ ëŒ€í™” íšŸìˆ˜ ê°ì†Œ
            // ì—¬ê¸°ì„œëŠ” currentCharacterKeyê°€ ê³§ globalReservation.maidKeyì™€ ê°™ë‹¤ê³  ê°€ì •
            if (selectedMaid) { // selectedMaidëŠ” ì´ë¯¸ ì˜ˆì•½ëœ ë©”ì´ë“œ ê°ì²´ë¥¼ ê°€ë¦¬í‚´
                selectedMaid.dailyTurnsLeft--;
                if (selectedMaid.dailyTurnsLeft <= 0) {
                    globalReservation.ended = true; // ëŒ€í™” íšŸìˆ˜ ì†Œì§„ìœ¼ë¡œ ì˜ˆì•½ ì¢…ë£Œ ìƒíƒœë¡œ ì „í™˜
                    appendMessage(`ì£¼ì¸ë‹˜, ì•„ì‰½ì§€ë§Œ '${selectedMaid.name}' ë©”ì´ë“œì™€ì˜ ì˜ˆì•½ëœ ëŒ€í™” íšŸìˆ˜ë¥¼ ëª¨ë‘ ì‚¬ìš©í•˜ì…¨ìŠµë‹ˆë‹¤.`, 'bot', true);
                    // ëŒ€í™” íšŸìˆ˜ ì†Œì§„ ì‹œ ìë™ìœ¼ë¡œ ë§ˆìŠ¤í„° í…œí‘¸ìŠ¤ë¡œ ì „í™˜
                    selectCharacter("master_tempus", true); // ë§ˆìŠ¤í„° í…œí‘¸ìŠ¤ ëŒ€í™” ê¸°ë¡ ë¡œë“œ ë° í™˜ì˜ ë©”ì‹œì§€ ì¶œë ¥
                }
            }

            updateReservationStatus(); // ì˜ˆì•½ ìƒíƒœ ë° ëŒ€í™” ê°€ëŠ¥ ì—¬ë¶€ ê°±ì‹ 
            saveAllState();
        }

        function clearChat() {
            if (!confirm("ëª¨ë“  ê²Œì„ ë°ì´í„°ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ì €ì¥ëœ ëŒ€í™” ê¸°ë¡, ì˜ˆì•½, ì‹œê°„ ë“±ì´ ëª¨ë‘ ì‚¬ë¼ì§‘ë‹ˆë‹¤.)")) {
                return;
            }

            chatDiv.innerHTML = '';
            
            // ëª¨ë“  ì±„íŒ… ê¸°ë¡ ë° ìš”ì•½ ì´ˆê¸°í™”
            chatHistories = {}; 
            
            gameTime = new Date();
            gameTime.setHours(9, 0, 0, 0); // ì˜¤ì „ 9ì‹œë¡œ ì´ˆê¸°í™”
            globalReservation = { maidKey: null, time: null, active: false, ended: false, reservedRoom: null };
            lastShiftDate = null;
            currentRoomKey = "front";

            // ëª¨ë“  ë©”ì´ë“œì˜ dailyTurnsLeft ì´ˆê¸°í™”
            for(const maidKey in allPlayableMaids) {
                allPlayableMaids[maidKey].dailyTurnsLeft = CONVERSATION_MAX_TURNS_PER_MAID;
            }

            generateDailyShift(); // ì¶œê·¼ë¶€ë„ ë‹¤ì‹œ ìƒì„±
            
            currentCharacterKey = "master_tempus"; 
            initializeCharacterChat(currentCharacterKey); 
            // ì´ˆê¸°í™” ì‹œ ë§ˆìŠ¤í„° í…œí‘¸ìŠ¤ì˜ í™˜ì˜ ë©”ì‹œì§€ ì¶œë ¥
            appendMessage(`${allCharactersMap[currentCharacterKey].greeting}`, 'bot', true);


            updateReservationStatus();
            updateGameTimeDisplay();
            updateCharacterDisplay();
            updateStatusPanel();
            saveAllState();
        }

        // --- ì¶œê·¼ë¶€ ìƒì„± í•¨ìˆ˜ ---
function generateDailyShift() {
            const playableMaidKeys = Object.keys(allPlayableMaids); // ì—¬ê¸°ì„œ ì˜¬ë°”ë¥´ê²Œ ì„ ì–¸ë˜ì—ˆìŠµë‹ˆë‹¤.
            if (playableMaidKeys.length === 0) {
                dailyShiftMaids = [];
                console.warn("ë“±ë¡ëœ ë©”ì´ë“œê°€ ì—†ì–´ ì¶œê·¼ë¶€ë¥¼ ìƒì„±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                populateMaidButtons();
                return;
            }

            const selectedMaids = [];
            // numToSelect ê³„ì‚° ì‹œ playableMaidKeysë¥¼ ì‚¬ìš©
            const numToSelect = Math.min(Math.floor(Math.random() * 3) + 2, playableMaidKeys.length); 
            
            // availableMaids ì´ˆê¸°í™” ì‹œ playableMaidKeysë¥¼ ì‚¬ìš©
            let availableMaids = [...playableMaidKeys]; 
            for (let i = 0; i < numToSelect; i++) {
                if (availableMaids.length === 0) break;
                const randomIndex = Math.floor(Math.random() * availableMaids.length);
                selectedMaids.push(availableMaids[randomIndex]);
                availableMaids.splice(randomIndex, 1);
            }
            dailyShiftMaids = selectedMaids;
            
            lastShiftDate = gameTime.toISOString().slice(0, 10); 
            
            // ì¶œê·¼í•œ ë©”ì´ë“œë“¤ì˜ dailyTurnsLeftë¥¼ ì´ˆê¸°í™”
            dailyShiftMaids.forEach(maidKey => {
                if (allPlayableMaids[maidKey]) {
                    allPlayableMaids[maidKey].dailyTurnsLeft = CONVERSATION_MAX_TURNS_PER_MAID;
                }
            });

            populateMaidButtons();
            saveAllState();
        }
        // --- ë©”ì´ë“œ ë²„íŠ¼ UI ì±„ìš°ê¸° í•¨ìˆ˜ ---
        function populateMaidButtons() {
            maidListContainer.innerHTML = '';

            if (dailyShiftMaids.length === 0) {
                const noMaidMessage = document.createElement('span');
                noMaidMessage.textContent = "ì˜¤ëŠ˜ ì¶œê·¼í•œ ë©”ì´ë“œê°€ ì—†ìŠµë‹ˆë‹¤. '1ì¼ ì „ì§„'ì„ í†µí•´ ì¶œê·¼ë¶€ë¥¼ ê°±ì‹ í•´ì£¼ì„¸ìš”.";
                maidListContainer.appendChild(noMaidMessage);
                return;
            }

            dailyShiftMaids.forEach(maidKey => {
                const maid = allPlayableMaids[maidKey];
                if (maid) {
                    const button = document.createElement('button');
                    button.textContent = `${maid.icon} ${maid.name.split(' ')[1].replace(/'/g, '')}`;
                    button.dataset.characterKey = maidKey;
                    // ë©”ì´ë“œ ë²„íŠ¼ í´ë¦­ ì‹œ í•´ë‹¹ ë©”ì´ë“œë¥¼ ì„ íƒ
                    button.addEventListener('click', () => {
                        selectCharacter(maidKey);
                    });
                    maidListContainer.appendChild(button);
                }
            });
            updateCharacterDisplay(); // ë²„íŠ¼ ìƒì„± í›„ ì„ íƒëœ ë²„íŠ¼ í™œì„±í™”
        }
        
        // --- ë°© ë²„íŠ¼ UI ì±„ìš°ê¸° í•¨ìˆ˜ ---
        function populateRoomButtons() {
            roomListContainer.innerHTML = '';
            for (const roomKey in rooms) {
                const button = document.createElement('button');
                button.textContent = rooms[roomKey].name;
                button.dataset.roomKey = roomKey;
                button.addEventListener('click', () => selectRoom(roomKey));
                roomListContainer.appendChild(button);
            }
            document.querySelectorAll('#room-list-container button').forEach(btn => {
                if (btn.dataset.roomKey === currentRoomKey) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
        }

        // --- ìºë¦­í„° ì„ íƒ í•¸ë“¤ëŸ¬ ---
        // selectChatHistory: true (ê¸°ë³¸ê°’)ëŠ” í•´ë‹¹ ìºë¦­í„°ì˜ ëŒ€í™” ê¸°ë¡ì„ ë¶ˆëŸ¬ì˜´
        // falseëŠ” ë¶ˆëŸ¬ì˜¤ì§€ ì•Šê³  UIë§Œ ì—…ë°ì´íŠ¸ (ì˜ˆ: ìë™ ì „í™˜ ì‹œ ë¶ˆí•„ìš”í•œ ë©”ì‹œì§€ ë°©ì§€)
        function selectCharacter(key, loadChatHistory = true) {
            currentCharacterKey = key;
            currentCharacter = allCharactersMap[currentCharacterKey];

            // í˜„ì¬ ì„ íƒëœ ìºë¦­í„° UI ì—…ë°ì´íŠ¸
            characterNameDisplay.textContent = currentCharacter.name;
            characterIconDisplay.textContent = currentCharacter.icon;

            // ë©”ì´ë“œ ë° ë§ˆìŠ¤í„° í…œí‘¸ìŠ¤ ë²„íŠ¼ í™œì„±í™”/ë¹„í™œì„±í™” ì—…ë°ì´íŠ¸
            document.querySelectorAll('#maid-list-container button').forEach(btn => {
                btn.classList.remove('active');
            });
            masterTempusBtn.classList.remove('active');

            const selectedBtn = document.querySelector(`button[data-character-key="${currentCharacterKey}"]`);
            if (selectedBtn) {
                selectedBtn.classList.add('active');
            } else if (currentCharacterKey === "master_tempus") {
                masterTempusBtn.classList.add('active');
            }

            // ì±„íŒ…ì°½ ë‚´ìš© ì—…ë°ì´íŠ¸
            chatDiv.innerHTML = ''; 
            initializeCharacterChat(currentCharacterKey); 
            let currentChatData = chatHistories[currentCharacterKey];

            // ëŒ€í™” ê¸°ë¡ ë¡œë“œë¥¼ ìš”ì²­í•œ ê²½ìš°ì—ë§Œ ê¸°ë¡ì„ ì¶œë ¥
            if (loadChatHistory) {
                // ë§ˆìŠ¤í„° í…œí‘¸ìŠ¤ëŠ” í•­ìƒ í™˜ì˜ ë©”ì‹œì§€ë¶€í„° ì‹œì‘
                if (currentCharacterKey === "master_tempus") {
                     appendMessage(currentCharacter.greeting, 'bot', true);
                } else {
                    // ì¼ë°˜ ë©”ì´ë“œ ì„ íƒ ì‹œ
                    // ìš”ì•½ ë‚´ìš©ì´ ìˆìœ¼ë©´ ë¨¼ì € ì¶œë ¥
                    if (currentChatData.currentSummary) {
                        appendMessage(`(ì´ì „ ëŒ€í™” ìš”ì•½: ${currentChatData.currentSummary})`, 'bot', true);
                    }
                    // í˜„ì¬ ìºë¦­í„°ì˜ ëŒ€í™” ê¸°ë¡ ì¶œë ¥
                    if (currentChatData.history && currentChatData.history.length > 0) {
                        currentChatData.history.forEach(msg => {
                            if (msg.role === "user") {
                                appendMessage(`${msg.parts[0].text}`, 'user');
                            } else if (msg.role === "model") {
                                appendMessage(`${msg.parts[0].text}`, 'bot', true);
                            }
                        });
                    } else {
                        // ê¸°ë¡ì´ ì—†ìœ¼ë©´ í™˜ì˜ ë©”ì‹œì§€ ì¶œë ¥
                        appendMessage(`${currentCharacter.greeting}`, 'bot', true);
                    }
                }
            }
            
            // ëª¨ë“  UI ë° ìƒíƒœ ì—…ë°ì´íŠ¸
            updateCharacterDisplay(); // ìƒíƒœì°½ ì—…ë°ì´íŠ¸ í¬í•¨
            // updateReservationStatus()ì™€ checkConversationAvailability()ëŠ” updateCharacterDisplay ë‚´ì—ì„œ í˜¸ì¶œë˜ë¯€ë¡œ ì—¬ê¸°ì„œ ë³„ë„ í˜¸ì¶œ ë¶ˆí•„ìš”
            saveAllState();
        }

        // --- ë°© ì„ íƒ í•¸ë“¤ëŸ¬ ---
        function selectRoom(key) {
            currentRoomKey = key;
            chatDiv.innerHTML = '';

            appendMessage(`ì£¼ì¸ë‹˜ê»˜ì„œ '${rooms[currentRoomKey].name}'(ìœ¼)ë¡œ ì´ë™í•˜ì…¨ìŠµë‹ˆë‹¤. ${rooms[currentRoomKey].description}`, 'bot', true);

            // ë°©ì„ ì´ë™í•˜ë©´ ì˜ˆì•½ ìƒíƒœì— ë”°ë¼ ë©”ì´ë“œê°€ ìë™ìœ¼ë¡œ ë“±ì¥í•˜ê±°ë‚˜, ë§ˆìŠ¤í„° í…œí‘¸ìŠ¤ë¡œ ìœ ì§€
            // ì´ë•Œ selectCharacterëŠ” ëŒ€í™” ê¸°ë¡ ë¡œë“œ ì—†ì´ UIë§Œ ê°±ì‹ í•´ì•¼ í•¨
            if (globalReservation.active && globalReservation.maidKey && currentRoomKey === globalReservation.reservedRoom) {
                selectCharacter(globalReservation.maidKey, true); // ì˜ˆì•½ëœ ë°©ì— ì…ì¥ ì‹œ ë©”ì´ë“œë¡œ ì „í™˜ (ëŒ€í™” ê¸°ë¡ ë¡œë“œ)
            } else {
                selectCharacter("master_tempus", true); // ì˜ˆì•½ëœ ë°©ì´ ì•„ë‹ˆë©´ ë§ˆìŠ¤í„° í…œí‘¸ìŠ¤ë¡œ ì „í™˜ (ëŒ€í™” ê¸°ë¡ ë¡œë“œ)
            }
            
            updateCharacterDisplay();
            saveAllState();
        }

        // --- ì˜ˆì•½ ì˜µì…˜ ì±„ìš°ê¸° í•¨ìˆ˜ ---
        function populateReservationOptions() {
            // ë©”ì´ë“œ ì„ íƒ
            reserveMaidSelect.innerHTML = '<option value="">--- ëŒ€í™”í•  ë©”ì´ë“œ ì„ íƒ ---</option>';
            dailyShiftMaids.forEach(maidKey => {
                const maid = allPlayableMaids[maidKey];
                const option = document.createElement('option');
                option.value = maidKey;
                option.textContent = maid.name;
                // í•´ë‹¹ ë©”ì´ë“œì˜ ë‚¨ì€ í„´ ìˆ˜ê°€ 0ì´ë©´ ì„ íƒ ë¶ˆê°€ëŠ¥í•˜ê²Œ
                if (maid.dailyTurnsLeft <= 0) {
                    option.disabled = true;
                    option.textContent += " (ëŒ€í™” íšŸìˆ˜ ì†Œì§„)";
                }
                reserveMaidSelect.appendChild(option);
            });

            // ë‚ ì§œ ì„ íƒ (ì˜¤ëŠ˜, ë‚´ì¼, ëª¨ë ˆ)
            reserveDateSelect.innerHTML = '';
            for (let i = 0; i < 3; i++) { // ì˜¤ëŠ˜ í¬í•¨ 3ì¼
                const date = new Date(gameTime);
                date.setDate(gameTime.getDate() + i);
                const option = document.createElement('option');
                option.value = date.toISOString().slice(0, 10); //YYYY-MM-DD
                option.textContent = `${date.getMonth() + 1}ì›” ${date.getDate()}ì¼ (${['ì˜¤ëŠ˜', 'ë‚´ì¼', 'ëª¨ë ˆ'][i]})`;
                reserveDateSelect.appendChild(option);
            }
            
            // ì‹œê°„ ì„ íƒ (ì˜¤ì „ 9ì‹œ ~ ì˜¤í›„ 6ì‹œ)
            reserveTimeSelect.innerHTML = '';
            for (let h = 9; h <= 18; h++) {
                const hour = h.toString().padStart(2, '0');
                const option = document.createElement('option');
                option.value = `${hour}:00`;
                option.textContent = `${hour}:00`;
                reserveTimeSelect.appendChild(option);
            }

            // ê¸°ì¡´ ì˜ˆì•½ì´ ìˆë‹¤ë©´ í•´ë‹¹ ê°’ìœ¼ë¡œ ì„ íƒë°•ìŠ¤ ê¸°ë³¸ê°’ ì„¤ì •
            if (globalReservation.time && globalReservation.maidKey && globalReservation.reservedRoom) {
                reserveMaidSelect.value = globalReservation.maidKey;
                reserveDateSelect.value = globalReservation.time.toISOString().slice(0, 10);
                const hours = globalReservation.time.getHours().toString().padStart(2, '0');
                reserveTimeSelect.value = `${hours}:00`;
            } else {
                 // ì˜ˆì•½ì´ ì—†ìœ¼ë©´ ì´ˆê¸°ê°’ìœ¼ë¡œ ì„¤ì •
                 reserveMaidSelect.value = '';
                 reserveDateSelect.value = gameTime.toISOString().slice(0, 10); // ì˜¤ëŠ˜ ë‚ ì§œë¡œ
                 reserveTimeSelect.value = '09:00'; // ì˜¤ì „ 9ì‹œë¡œ
            }
            checkReservationFormValidity(); // ì˜ˆì•½ í¼ ìœ íš¨ì„± í™•ì¸ í•¨ìˆ˜ ì´ë¦„ ë³€ê²½
        }

        // ì˜ˆì•½ í¼ ìœ íš¨ì„± í™•ì¸ ë° UI ì—…ë°ì´íŠ¸ (ì˜ˆì•½ í¼ ë²„íŠ¼ í™œì„±í™”/ë¹„í™œì„±í™”ìš©)
        function checkReservationFormValidity() {
            const selectedMaidKey = reserveMaidSelect.value;
            const selectedDateStr = reserveDateSelect.value;
            const selectedTimeStr = reserveTimeSelect.value;

            const reserveBtn = document.getElementById('reserve-btn');

            if (!selectedMaidKey || !selectedDateStr || !selectedTimeStr) {
                reserveBtn.disabled = true;
                reservationStatusDiv.textContent = "ëª¨ë“  ì˜ˆì•½ ì •ë³´ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.";
                reservationStatusDiv.className = "reservation-status";
                return;
            }

            const selectedDateTime = new Date(`${selectedDateStr}T${selectedTimeStr}:00`);

            // í˜„ì¬ ê²Œì„ ì‹œê°„ë³´ë‹¤ ì´ì „ ì‹œê°„ì€ ì˜ˆì•½ ë¶ˆê°€ëŠ¥
            if (selectedDateTime < gameTime) {
                reserveBtn.disabled = true;
                reservationStatusDiv.textContent = "ê³¼ê±° ì‹œê°„ì€ ì˜ˆì•½í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
                reservationStatusDiv.className = "reservation-status expired-chat";
                return;
            }

            // ì„ íƒëœ ë©”ì´ë“œì˜ ëŒ€í™” íšŸìˆ˜ê°€ 0ì´ë©´ ì˜ˆì•½ ë¶ˆê°€ëŠ¥
            if (allPlayableMaids[selectedMaidKey] && allPlayableMaids[selectedMaidKey].dailyTurnsLeft <= 0) {
                reserveBtn.disabled = true;
                reservationStatusDiv.textContent = `'${allPlayableMaids[selectedMaidKey].name}' ë©”ì´ë“œì™€ì˜ ëŒ€í™” íšŸìˆ˜ë¥¼ ëª¨ë‘ ì‚¬ìš©í–ˆìŠµë‹ˆë‹¤.`;
                reservationStatusDiv.className = "reservation-status expired-chat";
                return;
            }

            // ì´ë¯¸ í™œì„± ì˜ˆì•½ì´ ìˆëŠ” ê²½ìš°, ê¸°ì¡´ ì˜ˆì•½ê³¼ ì¶©ëŒí•˜ëŠ”ì§€ í™•ì¸
            if (globalReservation.time && !globalReservation.ended) {
                const existingReservationStart = globalReservation.time.getTime();
                const existingReservationEnd = existingReservationStart + 60 * 60 * 1000; // 1ì‹œê°„ ì˜ˆì•½

                const newReservationStart = selectedDateTime.getTime();
                const newReservationEnd = newReservationStart + 60 * 60 * 1000;

                // ì‹œê°„ ì¶©ëŒ (ì™„ì „íˆ ê²¹ì¹˜ê±°ë‚˜ ì¼ë¶€ ê²¹ì¹˜ëŠ” ê²½ìš°)
                const timeOverlap = !(newReservationEnd <= existingReservationStart || newReservationStart >= existingReservationEnd);
                
                // ìƒˆë¡œìš´ ì˜ˆì•½ì´ ê¸°ì¡´ ì˜ˆì•½ ì‹œê°„ê³¼ ê²¹ì¹˜ëŠ” ê²½ìš°
                if (timeOverlap) {
                     reserveBtn.disabled = true;
                     reservationStatusDiv.textContent = "ì„ íƒí•˜ì‹  ì‹œê°„ì€ ì´ë¯¸ ì˜ˆì•½ë˜ì–´ ìˆê±°ë‚˜ ì¶©ëŒí•©ë‹ˆë‹¤.";
                     reservationStatusDiv.className = "reservation-status expired-chat";
                     return;
                }
            }
            
            // ëª¨ë“  ê²€ì‚¬ í†µê³¼ ì‹œ ì˜ˆì•½ ê°€ëŠ¥
            reserveBtn.disabled = false;
            reservationStatusDiv.textContent = "ì˜ˆì•½ í™•ì • ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.";
            reservationStatusDiv.className = "reservation-status active-chat";
        }


        // --- ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ---
        sendBtn.addEventListener('click', sendMessage);
        clearBtn.addEventListener('click', clearChat);
        userInput.addEventListener('keydown', function (e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        // ë§ˆìŠ¤í„° í…œí‘¸ìŠ¤ ë²„íŠ¼ í´ë¦­ ì‹œ ë§ˆìŠ¤í„° í…œí‘¸ìŠ¤ ì„ íƒ (ì˜ˆì•½ UI ì—´ë¦¼)
        masterTempusBtn.addEventListener('click', () => selectCharacter("master_tempus"));

        // ì˜ˆì•½ UI ê´€ë ¨ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        reserveMaidSelect.addEventListener('change', checkReservationFormValidity);
        reserveDateSelect.addEventListener('change', checkReservationFormValidity);
        reserveTimeSelect.addEventListener('change', checkReservationFormValidity);

        reserveBtn.addEventListener('click', function() {
            const selectedMaidKey = reserveMaidSelect.value;
            const selectedDateStr = reserveDateSelect.value;
            const selectedTimeStr = reserveTimeSelect.value;

            if (!selectedMaidKey || !selectedDateStr || !selectedTimeStr) {
                alert("ëª¨ë“  ì˜ˆì•½ ì •ë³´ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");
                return;
            }

            const reservationDateTime = new Date(`${selectedDateStr}T${selectedTimeStr}:00`);

            // ì¶”ê°€ì ì¸ ìœ íš¨ì„± ê²€ì‚¬ (í´ë¼ì´ì–¸íŠ¸ ë‹¨ì—ì„œ ë‹¤ì‹œ í™•ì¸)
            if (reservationDateTime < gameTime) {
                alert("ê³¼ê±° ì‹œê°„ì€ ì˜ˆì•½í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                return;
            }
            
            // ì„ íƒëœ ë©”ì´ë“œì˜ ëŒ€í™” íšŸìˆ˜ê°€ 0ì´ë©´ ì˜ˆì•½ ë¶ˆê°€ëŠ¥
            if (allPlayableMaids[selectedMaidKey] && allPlayableMaids[selectedMaidKey].dailyTurnsLeft <= 0) {
                alert(`'${allPlayableMaids[selectedMaidKey].name}' ë©”ì´ë“œì™€ì˜ ëŒ€í™” íšŸìˆ˜ë¥¼ ëª¨ë‘ ì‚¬ìš©í–ˆìŠµë‹ˆë‹¤. ì´ ë©”ì´ë“œëŠ” ì˜ˆì•½í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);
                return;
            }

            // ê¸°ì¡´ ì˜ˆì•½ ì¶©ëŒ í™•ì¸ (ìƒˆë¡œìš´ ì˜ˆì•½ê³¼ ê²¹ì¹˜ëŠ”ì§€ ë‹¤ì‹œ í™•ì¸)
            if (globalReservation.time && !globalReservation.ended) {
                const existingReservationStart = globalReservation.time.getTime();
                const existingReservationEnd = existingReservationStart + 60 * 60 * 1000; // 1ì‹œê°„ ì˜ˆì•½

                const newReservationStart = reservationDateTime.getTime();
                const newReservationEnd = newReservationStart + 60 * 60 * 1000;

                const timeOverlap = !(newReservationEnd <= existingReservationStart || newReservationStart >= existingReservationEnd);
                
                if (timeOverlap) { 
                     alert("ì„ íƒí•˜ì‹  ì‹œê°„ì€ ì´ë¯¸ ì˜ˆì•½ë˜ì–´ ìˆê±°ë‚˜ ì¶©ëŒí•©ë‹ˆë‹¤. ë‹¤ë¥¸ ì‹œê°„ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
                     return;
                }
            }

            // ë¹„ì–´ìˆëŠ” ë°© ëœë¤ ë°°ì •
            const availableRooms = reservableRoomKeys.filter(roomKey => {
                // ì´ ê³³ì— 'íŠ¹ì • ë°©ì´ ì´ë¯¸ ë‹¤ë¥¸ ì˜ˆì•½ìœ¼ë¡œ ì°¨ìˆëŠ”ì§€' ë“±ì˜ ê³ ê¸‰ ë¡œì§ì´ ë“¤ì–´ê°ˆ ìˆ˜ ìˆì§€ë§Œ,
                // í˜„ì¬ëŠ” ë‹¨ìˆœíˆ ì˜ˆì•½ ê°€ëŠ¥í•œ ë°© ì¤‘ì—ì„œ ëœë¤ìœ¼ë¡œ ì„ íƒ
                return true; 
            });

            if (availableRooms.length === 0) {
                alert("í˜„ì¬ ì˜ˆì•½ ê°€ëŠ¥í•œ ë¹ˆ ë°©ì´ ì—†ìŠµë‹ˆë‹¤. ë‹¤ë¥¸ ì‹œê°„ì„ ì„ íƒí•˜ê±°ë‚˜ '1ì¼ ì „ì§„' í•´ì£¼ì„¸ìš”.");
                return;
            }
            const randomRoomKey = availableRooms[Math.floor(Math.random() * availableRooms.length)];


            // ì˜ˆì•½ ì„±ê³µ ì‹œ globalReservation ì—…ë°ì´íŠ¸
            globalReservation = {
                maidKey: selectedMaidKey,
                time: reservationDateTime,
                active: false, // ì˜ˆì•½ í™•ì • ì‹œì—ëŠ” ì•„ì§ í™œì„±í™”ë˜ì§€ ì•ŠìŒ
                ended: false,
                reservedRoom: randomRoomKey // ëœë¤ìœ¼ë¡œ ë°°ì •ëœ ë°© í‚¤ í• ë‹¹
            };
            alert(`ë§ˆìŠ¤í„° í…œí‘¸ìŠ¤ê°€ '${allCharactersMap[selectedMaidKey].name}' ë©”ì´ë“œì™€ ${reservationDateTime.toLocaleString('ko-KR', { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' })}ì— '${rooms[randomRoomKey].name}'ì—ì„œ ì£¼ì¸ë‹˜ì„ ìœ„í•œ ì‹œê°„ì„ ì˜ˆì•½í–ˆìŠµë‹ˆë‹¤. ì˜ˆì•½ ì‹œê°„ì— í•´ë‹¹ ë°©ìœ¼ë¡œ ì´ë™í•´ ì£¼ì„¸ìš”!`);
            
            updateReservationStatus(); // ì˜ˆì•½ ìƒíƒœ UI ë° `globalReservation.active` ì—…ë°ì´íŠ¸
            saveAllState();
            populateReservationOptions(); // ì˜ˆì•½ í›„ ì˜ˆì•½ ì˜µì…˜ ë‹¤ì‹œ ì±„ì›Œ ì¶©ëŒ ì •ë³´ ë“± ì—…ë°ì´íŠ¸
        });


        forward1HourBtn.addEventListener('click', function() {
            gameTime.setHours(gameTime.getHours() + 1);
            updateGameTimeDisplay(); 
            updateReservationStatus(); // ì‹œê°„ì´ ë³€ê²½ë˜ë©´ ì˜ˆì•½ ìƒíƒœë¥¼ ë‹¤ì‹œ í™•ì¸í•˜ê³  UI ì—…ë°ì´íŠ¸
            updateStatusPanel();
            saveAllState();
            // ì‹œê°„ì´ ë³€ê²½ë˜ì—ˆìœ¼ë¯€ë¡œ ì˜ˆì•½ í¼ì˜ ìœ íš¨ì„±ë„ ë‹¤ì‹œ í™•ì¸
            if (currentCharacterKey === "master_tempus") { 
                populateReservationOptions();
            }
        });

        forward1DayBtn.addEventListener('click', function() {
            gameTime.setDate(gameTime.getDate() + 1);
            gameTime.setHours(9, 0, 0, 0); // ìƒˆ ë‚ ì§œì˜ ì‹œì‘ ì‹œê°„ì€ ì˜¤ì „ 9ì‹œë¡œ ì´ˆê¸°í™”

            // ë‚ ì§œê°€ ë°”ë€Œì—ˆìœ¼ë¯€ë¡œ ì¶œê·¼ë¶€ ê°±ì‹ 
            generateDailyShift(); 

            // ì˜ˆì•½ ìƒíƒœ ì´ˆê¸°í™” (ë‚ ì§œê°€ ë°”ë€Œì—ˆìœ¼ë¯€ë¡œ ì´ì „ ì˜ˆì•½ì€ ë¬´íš¨)
            globalReservation = { maidKey: null, time: null, active: false, ended: false, reservedRoom: null };
            
            // í˜„ì¬ ì„ íƒëœ ìºë¦­í„°ë¥¼ ë§ˆìŠ¤í„° í…œí‘¸ìŠ¤ë¡œ ê°•ì œ ì „í™˜
            selectCharacter("master_tempus", true); // ìƒˆ ë‚ ì—ëŠ” ë§ˆìŠ¤í„° í…œí‘¸ìŠ¤ì—ê²Œ ì˜ˆì•½ë¶€í„° (ëŒ€í™” ê¸°ë¡ ë¡œë“œ)

            updateGameTimeDisplay(); 
            updateReservationStatus();
            updateStatusPanel();
            saveAllState();
            populateReservationOptions(); // ì˜ˆì•½ UI ì—…ë°ì´íŠ¸
        });

        // í–„ë²„ê±° ë©”ë‰´ í† ê¸€ (ëª¨ë°”ì¼)
        hamburgerMenu.addEventListener('click', () => {
            statusPanel.classList.add('active'); 
        });
        // ìƒíƒœ íŒ¨ë„ ë‹«ê¸° ë²„íŠ¼ (ëª¨ë°”ì¼)
        closeStatusPanelBtn.addEventListener('click', () => {
            statusPanel.classList.remove('active');
        });


        // --- ì´ˆê¸°í™” ë¡œì§ (í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰) ---
        // ëª¨ë“  ìƒíƒœ ë¡œë“œ
        loadAllState();

        // ì¶œê·¼ë¶€ ê°±ì‹  ë¡œì§ (ë‚ ì§œ ë³€ê²½ë˜ì—ˆê±°ë‚˜ ì¶œê·¼ë¶€ê°€ ë¹„ì–´ìˆìœ¼ë©´)
        const currentGameDate = gameTime.toISOString().slice(0, 10);
        if (currentGameDate !== lastShiftDate || dailyShiftMaids.length === 0) {
            generateDailyShift(); 
        } else {
            populateMaidButtons(); 
        }
        
        // ë°© ë²„íŠ¼ ì±„ìš°ê¸°
        populateRoomButtons();

        // ì´ˆê¸° ë¡œë“œ ì‹œ ì˜ˆì•½ ìƒíƒœì— ë”°ë¼ ìºë¦­í„° ì„ íƒ ë° ì±„íŒ…ì°½ ë©”ì‹œì§€ ì„¤ì •
        // updateReservationStatus()ëŠ” `globalReservation.active` ìƒíƒœë¥¼ ê²°ì •í•˜ê³  `checkConversationAvailability()`ë¥¼ í˜¸ì¶œ
        // selectCharacter()ëŠ” `currentCharacterKey`ë¥¼ ì„¤ì •í•˜ê³  UIë¥¼ ì—…ë°ì´íŠ¸í•˜ë©° `checkConversationAvailability()`ë¥¼ í˜¸ì¶œ
        updateReservationStatus(); 
        selectCharacter(currentCharacterKey, true); // ì´ˆê¸° ë¡œë“œ ì‹œ ëŒ€í™” ê¸°ë¡ ë¡œë“œ (ì‹œì‘ ë©”ì‹œì§€ ë“± í¬í•¨)
        
        // ëª¨ë“  ìƒíƒœ íŒ¨ë„ ì—…ë°ì´íŠ¸
        updateStatusPanel();
    </script>
</body>
</html>
